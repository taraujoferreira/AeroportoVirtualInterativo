<!doctype html>
<html lang="pt">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aeroporto VR â€” Wayfinding</title>

    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

<script>
AFRAME.registerComponent("face-camera", {
  tick: function () {
    const cam = document.getElementById("cam");
    if (!cam) return;
    const camPos = cam.object3D.getWorldPosition(new THREE.Vector3());
    this.el.object3D.lookAt(camPos);
    this.el.object3D.rotation.x = 0;
    this.el.object3D.rotation.z = 0;
  },
});

AFRAME.registerComponent("wayfinding", {
  init: function () {
    this.state = {
      checkinMode: null,                 // "online" | "airport"
      started: false,

      handWeight: 0,
      hasCheckedBag: false,              // se existe mala de porÃ£o
      checkedIn: false,                  // se jÃ¡ foi despachada (bag drop)
      luggageWeight: 0,
      
      checkedItems: [],               // "luggage" | "backpack"

      boardingPassIssued: false,
      passengerIdentified: false,        // airport: depois de inserir dados

      security: {
        boardingPassShown: false,
        scannedBackpack: false,
        scannedPhone: false,
        scannedLuggage: false,
      },

      items: {
        backpack: true,
        phone: true,
        luggage: false,
      },


      securityPassed: false,
      gate: null,
      destination: null,
    };

    // UI temporÃ¡ria do painel inicial 3D
    this.ui = {
      mode: null,
      hasBackpack: true,
      hasPhone: true,
      hasLuggage: false,
      handWeight: 6,
      luggageWeight: 0,
      onlineChecked: false,

      desk: {            // âœ… ADICIONA ISTO
        code: "",
        bagChoice: "hand",
      },
    };



    this.el.sceneEl.addEventListener("loaded", () => {
      this.hudTarget = document.getElementById("hudTarget");
      this.successSound = document.getElementById("soundSuccess");
      this.wall = document.getElementById("securityWall");
      this.wallText = document.getElementById("securityWallText");

      this.checkinDeskHit = document.getElementById("checkinDeskHit");
      this.bagDropzone = document.getElementById("baggageDropzone");
      this.securityDropzone = document.getElementById("securityDropzone");
      this.bpReader = document.getElementById("bpReader");

      this.checkinDeskHit?.addEventListener("click", () => this.onDeskClick());

      // Abrir painel de seguranÃ§a clicando no cÃ­rculo verde OU no leitor
      this.securityDropzone?.addEventListener("click", () => this.openSecurityPanel());
      this.bpReader?.addEventListener("click", () => this.openBPPanel());



      // Bag Drop abre â€œdespacharâ€
      this.bagDropzone?.addEventListener("click", () => this.onBagDropClick());

      this.setObjective("âœˆï¸ Configura o fluxo no painel e clica ComeÃ§ar.", null);
      this.updateBPUI();

      // âœ… painel inicial 3D (bind + refresh)
      this.bindFlowPanelButtons();
      this.refreshFlowPanel();

    });
  },

  // -------- UI Objective + BP ----------
  setObjective: function (text, targetId = null) {
    if (this.hudTarget) this.hudTarget.textContent = text;

    document.querySelectorAll("[data-highlighted='1']").forEach(el => {
      el.removeAttribute("animation__pulse");
      el.setAttribute("data-highlighted", "0");
    });

    if (!targetId) return;
    const el = document.getElementById(targetId);
    if (!el) return;

    el.setAttribute("data-highlighted", "1");
    el.setAttribute(
      "animation__pulse",
      "property: scale; dir: alternate; dur: 700; easing: easeInOutSine; loop: true; to: 1.05 1.05 1.05"
    );
  },

  issueBoardingPass: function () {
    const pool = [
      { gate: "A1", dest: "Paris" },
      { gate: "A2", dest: "Londres" },
      { gate: "A3", dest: "Madrid" },
    ];
    const pick = pool[Math.floor(Math.random() * pool.length)];

    this.state.gate = pick.gate;
    this.state.destination = pick.dest;
    this.state.boardingPassIssued = true;

    const bp = document.getElementById("boardingPass");
    if (bp) bp.style.display = "block";

    this.updateBPUI();
    this.successSound?.components?.sound?.playSound?.();
  },

updateBPUI: function () {
  const l1 = document.getElementById("bpLine1");
  const l2 = document.getElementById("bpLine2");

  const gate = this.state.gate ?? "â€”";
  const dest = this.state.destination ?? "â€”";
  if (l1) l1.textContent = `Gate: ${gate} | Destino: ${dest}`;

  const bpOk = this.state.boardingPassIssued ? "âœ…" : "â›”";
  const idOk = this.state.checkinMode === "airport"
    ? (this.state.passengerIdentified ? "âœ…" : "â›”")
    : "â€”";

  // porÃ£o: se hÃ¡ itens para porÃ£o, tens de os despachar
  const checkedItems = Array.isArray(this.state.checkedItems) ? this.state.checkedItems : [];
  const porao = checkedItems.length > 0 ? (this.state.checkedIn ? "âœ…" : "â›”") : "â€”";

  const bpShown = this.state.security?.boardingPassShown ? "âœ…" : "â›”";

  // âœ… ler inventÃ¡rio real
  const carry = this.getCarrySys?.();
  const inv = carry?.inventory || { backpack: false, phone: false, luggage: false };

  // âœ… existe no jogo (selecionado no modal inicial)
  const existsBackpack = !!this.state.items?.backpack;
  const existsPhone = !!this.state.items?.phone;
  const existsLuggage = !!this.state.items?.luggage;

  // âœ… ainda estÃ¡ contigo (no inventÃ¡rio)
  const carryBackpack = !!inv.backpack;
  const carryPhone = !!inv.phone;
  const carryLuggage = !!inv.luggage;

  // âœ… mala sÃ³ Ã© â€œcabineâ€ se NÃƒO estiver nos itens de porÃ£o
  const luggageInHold = checkedItems.includes("luggage");
  const needLuggage = existsLuggage && carryLuggage && !luggageInHold;

  // âœ… sÃ³ Ã© necessÃ¡rio scanar se existe E estÃ¡ contigo
  const needBackpack = existsBackpack && carryBackpack;
  const needPhone = existsPhone && carryPhone;

  const scanOk =
    (!needBackpack || !!this.state.security?.scannedBackpack) &&
    (!needPhone || !!this.state.security?.scannedPhone) &&
    (!needLuggage || !!this.state.security?.scannedLuggage);

  const secOk = this.state.securityPassed ? "âœ…" : "â›”";

  if (l2) l2.textContent =
    `BP: ${bpOk} â€¢ IdentificaÃ§Ã£o: ${idOk} â€¢ PorÃ£o: ${porao} â€¢ BP mostrado: ${bpShown} â€¢ Scanner: ${scanOk ? "âœ…" : "â›”"} â€¢ SeguranÃ§a: ${secOk}`;
},


bindFlowPanelButtons: function () {
  if (this._flowBound) return;
  this._flowBound = true;

  const $ = (id) => document.getElementById(id);

  // modo
  $("uiModeOnline")?.addEventListener("click", () => {
    this.ui.mode = "online";
    this.refreshFlowPanel();
  });
  $("uiModeAirport")?.addEventListener("click", () => {
    this.ui.mode = "airport";
    this.refreshFlowPanel();
  });

  // toggles pertences
  $("uiHasBackpack")?.addEventListener("click", () => {
    this.ui.hasBackpack = !this.ui.hasBackpack;
    this.refreshFlowPanel();
  });
  $("uiHasPhone")?.addEventListener("click", () => {
    this.ui.hasPhone = !this.ui.hasPhone;
    this.refreshFlowPanel();
  });
  $("uiHasLuggage")?.addEventListener("click", () => {
    this.ui.hasLuggage = !this.ui.hasLuggage;
    // se tirou mala, nÃ£o faz sentido despachar mala
    if (!this.ui.hasLuggage) this.ui.onlineChecked = false;
    this.refreshFlowPanel();
  });

  // pesos (+/-) (passos de 1kg, ajusta se quiseres 0.5)
  $("uiHandMinus")?.addEventListener("click", () => {
    this.ui.handWeight = Math.max(0, (this.ui.handWeight || 0) - 1);
    this.refreshFlowPanel();
  });
  $("uiHandPlus")?.addEventListener("click", () => {
    this.ui.handWeight = (this.ui.handWeight || 0) + 1;
    this.refreshFlowPanel();
  });

  $("uiLuggMinus")?.addEventListener("click", () => {
    this.ui.luggageWeight = Math.max(0, (this.ui.luggageWeight || 0) - 1);
    this.refreshFlowPanel();
  });
  $("uiLuggPlus")?.addEventListener("click", () => {
    this.ui.luggageWeight = (this.ui.luggageWeight || 0) + 1;
    this.refreshFlowPanel();
  });

  // online checked
  $("uiOnlineChecked")?.addEventListener("click", () => {
    if (this.ui.mode !== "online") return;
    if (!this.ui.hasLuggage) return; // sÃ³ faz sentido se tiver mala
    this.ui.onlineChecked = !this.ui.onlineChecked;
    this.refreshFlowPanel();
  });

  // comeÃ§ar
  $("uiFlowStart")?.addEventListener("click", () => this.startFlowFromPanel());
},

refreshFlowPanel: function () {
  const $ = (id) => document.getElementById(id);

  // textos SIM/NÃƒO
  $("uiHasBackpackTxt")?.setAttribute("value", `ðŸŽ’ Mochila: ${this.ui.hasBackpack ? "SIM" : "NÃƒO"}`);
  $("uiHasPhoneTxt")?.setAttribute("value", `ðŸ“± TelemÃ³vel: ${this.ui.hasPhone ? "SIM" : "NÃƒO"}`);
  $("uiHasLuggageTxt")?.setAttribute("value", `ðŸ§³ Mala: ${this.ui.hasLuggage ? "SIM" : "NÃƒO"}`);

  $("uiHandWLabel")?.setAttribute("value", `Peso mochila: ${(this.ui.handWeight || 0).toFixed(1)}kg`);
  $("uiLuggWLabel")?.setAttribute("value", `Peso mala: ${(this.ui.luggageWeight || 0).toFixed(1)}kg`);

  // online checked visÃ­vel sÃ³ no modo online
  const onlineRow = document.getElementById("uiOnlineChecked");
  if (onlineRow) onlineRow.setAttribute("visible", this.ui.mode === "online");
  $("uiOnlineCheckedTxt")?.setAttribute(
    "value",
    `(Online) Despachar mala: ${this.ui.onlineChecked ? "SIM" : "NÃƒO"}`
  );

  // warn
  let warn = "";
  if (!this.ui.mode) warn = "âš ï¸ Escolhe o modo (Online ou Aeroporto).";
  $("uiFlowWarn")?.setAttribute("value", warn);
},


startFlowFromPanel: function () {
  if (!this.ui.mode) {
    document.getElementById("uiFlowWarn")?.setAttribute("value", "âš ï¸ Escolhe o modo primeiro.");
    return;
  }

  // aplica ao state real
  this.state.checkinMode = this.ui.mode;
  this.state.started = true;

  this.state.items = {
    backpack: !!this.ui.hasBackpack,
    phone: !!this.ui.hasPhone,
    luggage: !!this.ui.hasLuggage,
  };

  this.state.handWeight = this.state.items.backpack ? (this.ui.handWeight || 0) : 0;
  this.state.luggageWeight = this.state.items.luggage ? (this.ui.luggageWeight || 0) : 0;

  // reset do fluxo
  this.state.checkedItems = [];
  this.state.checkedIn = false;
  this.state.security.boardingPassShown = false;
  this.state.security.scannedBackpack = false;
  this.state.security.scannedPhone = false;
  this.state.security.scannedLuggage = false;

  // regras (igual ao que tinhas, agora no painel)
  const forcedByLuggage = this.state.items.luggage && this.state.luggageWeight > 20;
  const forcedByBackpack = this.state.items.backpack && this.state.handWeight > 10;
  const wantsChecked = !!this.ui.onlineChecked;

  if (this.state.checkinMode === "online") {
    if (forcedByLuggage) this.state.checkedItems.push("luggage");
    if (forcedByBackpack) this.state.checkedItems.push("backpack");
    if (!forcedByLuggage && this.state.items.luggage && wantsChecked) {
      if (!this.state.checkedItems.includes("luggage")) this.state.checkedItems.push("luggage");
    }
  } else {
    // airport: decisÃ£o no balcÃ£o (mantÃ©ns o deskModal ou fazes deskPanel depois)
    this.state.checkedItems = [];
  }

  this.state.hasCheckedBag = this.state.checkedItems.length > 0;

  // esconder painel inicial
  document.getElementById("uiFlowPanel")?.setAttribute("visible", "false");

  // inventÃ¡rio
  const carry = this.getCarrySys();
  carry?.syncFromFlowState?.(this.state);

  // continua o teu fluxo normal
  if (this.state.checkinMode === "online") {
    if (!this.state.boardingPassIssued) this.issueBoardingPass();

    if (this.state.checkedItems.length > 0) {
      this.setObjective("ðŸ§³ Vai ao BAG DROP (cÃ­rculo roxo) para despachar.", "baggageDropzone");
    } else {
      this.setObjective("ðŸ” Vai Ã  seguranÃ§a (cÃ­rculo verde) e completa o scanner.", "securityDropzone");
    }
  } else {
    this.setObjective("ðŸ¢ Vai ao balcÃ£o de check-in e insere os teus dados.", "checkinDeskHit");
  }

  this.updateBPUI();
},

openBagDropPanel: function () {
  const panel = document.getElementById("uiBagDropPanel");
  if (!panel) return;

  panel.setAttribute("visible", "true");
  this.bindBagDropPanelButtons();
  this.refreshBagDropPanel();
},

bindBagDropPanelButtons: function () {
  if (this._bagBound) return;
  this._bagBound = true;

  const btnClose = document.getElementById("uiBagDropClose");
  const btnL = document.getElementById("uiDropLuggage");
  const btnB = document.getElementById("uiDropBackpack");

  btnClose?.addEventListener("click", () => {
    document.getElementById("uiBagDropPanel")?.setAttribute("visible", "false");
  });

  btnL?.addEventListener("click", () => this.dropSpecificToHold("luggage"));
  btnB?.addEventListener("click", () => this.dropSpecificToHold("backpack"));
},

refreshBagDropPanel: function () {
  const checked = Array.isArray(this.state.checkedItems) ? this.state.checkedItems : [];
  const carry = this.getCarrySys();
  const t = document.getElementById("uiBagDropStatus");

  const hasL = checked.includes("luggage");
  const hasB = checked.includes("backpack");

  // mostrar/esconder botÃµes conforme necessÃ¡rio
  document.getElementById("uiDropLuggage")?.setAttribute("visible", hasL);
  document.getElementById("uiDropLuggageTxt")?.setAttribute("visible", hasL);

  document.getElementById("uiDropBackpack")?.setAttribute("visible", hasB);
  document.getElementById("uiDropBackpackTxt")?.setAttribute("visible", hasB);

  const falta = checked.map(x => (x === "luggage" ? "mala" : "mochila")).join(" + ");
  if (t) t.setAttribute("value", `Falta despachar: ${falta}`);

  // se por acaso jÃ¡ nÃ£o tens um item no inventÃ¡rio, avisa no objective
  if (hasL && !carry?.inventory?.luggage) this.setObjective("âš ï¸ NÃ£o tens a mala no inventÃ¡rio.", null);
  if (hasB && !carry?.inventory?.backpack) this.setObjective("âš ï¸ NÃ£o tens a mochila no inventÃ¡rio.", null);
},

dropSpecificToHold: function (item) {
  this.state.checkedItems = this.state.checkedItems || [];
  const carry = this.getCarrySys();

  if (!this.state.checkedItems.includes(item)) {
    this.refreshBagDropPanel();
    return;
  }

  // tem de estar no inventÃ¡rio
  if (!carry?.inventory?.[item]) {
    const nome = item === "luggage" ? "mala" : "mochila";
    this.setObjective(`âš ï¸ NÃ£o tens ${nome} no inventÃ¡rio. Abre o inventÃ¡rio (I).`, null);
    carry?.openInventoryUI?.();
    return;
  }

  // remove definitivamente
  carry?.removeForever?.(item);

  // remove da lista
  this.state.checkedItems = this.state.checkedItems.filter(x => x !== item);

  this.successSound?.components?.sound?.playSound?.();

  // se acabou tudo:
  if (this.state.checkedItems.length === 0) {
    this.state.checkedIn = true;
    this.state.hasCheckedBag = false;

    document.getElementById("uiBagDropPanel")?.setAttribute("visible", "false");
    this.setObjective("âœ… Tudo despachado. Agora vai Ã  seguranÃ§a.", "securityDropzone");
  } else {
    this.state.checkedIn = false;
    this.state.hasCheckedBag = true;
    this.setObjective("âœ… Item despachado. Falta despachar o resto.", "baggageDropzone");
    this.refreshBagDropPanel();
  }

  this.updateBPUI();
},








  // -------- Modal Inicial (online/aeroporto + peso + porÃ£o online) ----------
  bindFlowModal: function () {
    const modal = document.getElementById("flowModal");
    const bOnline = document.getElementById("mOnline");
    const bAirport = document.getElementById("mAirport");
    const start = document.getElementById("flowStart");
    const warn = document.getElementById("flowWarn");
    const onlineExtra = document.getElementById("onlineExtra");
    const handWeight = document.getElementById("handWeight");
    const luggageWeight = document.getElementById("luggageWeight");


    if (!modal || !bOnline || !bAirport || !start || !warn || !onlineExtra || !handWeight) {
      setTimeout(() => this.bindFlowModal(), 50);
      return;
    }

    const setMode = (mode) => {
      this.state.checkinMode = mode;
      onlineExtra.style.display = (mode === "online") ? "block" : "none";
      warn.textContent = `Modo selecionado: ${mode === "online" ? "Online" : "Aeroporto"}`;
    };

    const syncOnlineCheckedUI = () => {
    const hasLuggageNow = document.getElementById("hasLuggage")?.checked ?? false;
    const onlineChecked = document.getElementById("onlineChecked");

    if (!onlineChecked) return;

    if (!hasLuggageNow) {
      onlineChecked.checked = false;
      onlineChecked.disabled = true;
    } else {
      onlineChecked.disabled = false;
    }
  };

  // sempre que mexes na mala
  document.getElementById("hasLuggage")?.addEventListener("change", syncOnlineCheckedUI);

  // quando escolhes online mostra e sincroniza
  bOnline.addEventListener("click", () => {
    setMode("online");
    syncOnlineCheckedUI();
  });

    bAirport.addEventListener("click", () => setMode("airport"));

start.addEventListener("click", () => {
  if (!this.state.checkinMode) {
    warn.textContent = "âš ï¸ Escolhe primeiro: Online ou Aeroporto.";
    return;
  }

  // âœ… Ler pertences NO MOMENTO do click
  const hasBackpack = document.getElementById("hasBackpack")?.checked ?? false;
  const hasPhone = document.getElementById("hasPhone")?.checked ?? false;
  const hasLuggage = document.getElementById("hasLuggage")?.checked ?? false;

  const lw = parseFloat(luggageWeight?.value || "0") || 0;
  const w = parseFloat(handWeight?.value || "0") || 0;

  // garantir state
  this.state.items = this.state.items || { backpack: false, phone: false, luggage: false };
  this.state.security = this.state.security || {
    boardingPassShown: false,
    scannedBackpack: false,
    scannedPhone: false,
    scannedLuggage: false,
  };

  this.state.items.backpack = !!hasBackpack;
  this.state.items.phone = !!hasPhone;
  this.state.items.luggage = !!hasLuggage;

  // pesos
  this.state.handWeight = this.state.items.backpack ? w : 0;
  this.state.luggageWeight = this.state.items.luggage ? lw : 0;

  // reset
  this.state.checkedItems = [];
  this.state.checkedIn = false;
  warn.textContent = "";


  // regras
  const forcedByLuggage = this.state.items.luggage && this.state.luggageWeight > 20;
  const forcedByBackpack = this.state.items.backpack && this.state.handWeight > 10;
  const wantsChecked = document.getElementById("onlineChecked")?.checked ?? false;

  if (this.state.checkinMode === "online") {
    // obrigatÃ³rios por peso
    if (forcedByLuggage) {
      this.state.checkedItems.push("luggage");
      warn.textContent = "âš ï¸ Mala > 20kg: porÃ£o obrigatÃ³rio.";
    }
    if (forcedByBackpack) {
      this.state.checkedItems.push("backpack");
      warn.textContent = warn.textContent || "âš ï¸ Mochila > 10kg: porÃ£o obrigatÃ³rio.";
    }

    // opcional (user quer despachar mala)
    if (!forcedByLuggage && this.state.items.luggage && wantsChecked) {
      this.state.checkedItems.push("luggage");
    }
  } else {
    // airport: decisÃ£o no balcÃ£o
    this.state.checkedItems = [];
  }
  this.state.hasCheckedBag = this.state.checkedItems.length > 0;



  // âœ… FECHAR MODAL + INICIAR FLUXO (isto faltava!)
  modal.style.display = "none";
  this.state.started = true;

  // âœ… sincroniza inventÃ¡rio (itens comeÃ§am no inventÃ¡rio)
  const carry = this.getCarrySys();
  carry?.syncFromFlowState?.(this.state);

  // objetivos
  const needsBagDrop = (this.state.checkedItems?.length || 0) > 0;

  if (this.state.checkinMode === "online") {
    if (!this.state.boardingPassIssued) this.issueBoardingPass();

    if (needsBagDrop) {
      this.setObjective("ðŸ§³ Vai ao BAG DROP (cÃ­rculo roxo) para despachar o item.", "baggageDropzone");
    } else {
      this.setObjective("ðŸ” Vai Ã  seguranÃ§a (cÃ­rculo verde) e completa o scanner.", "securityDropzone");
    }
  } else {
    this.setObjective("ðŸ¢ Vai ao balcÃ£o de check-in e insere os teus dados.", "checkinDeskHit");
  }

  this.updateBPUI();
});


    syncOnlineCheckedUI();

  },


  // -------- BalcÃ£o (airport): inserir dados + decidir porÃ£o (com regra) ----------
  onDeskClick: function () {
    if (!this.state.started) return;

  if (this.state.checkinMode === "airport") {
    this.openDeskPanel();
    return;
  }


    // online: balcÃ£o pode sÃ³ orientar (opcional)
    if (this.state.checkinMode === "online") {
      if (this.state.hasCheckedBag && !this.state.checkedIn) {
        this.setObjective("ðŸ§³ Vai ao BAG DROP para despachar a mala.", "baggageDropzone");
      } else {
        this.setObjective("ðŸ” Vai Ã  seguranÃ§a e completa o scanner.", "securityDropzone");
      }
    }
  },

  openDeskModal: function () {
    const modal = document.getElementById("deskModal");
    const rHand = document.getElementById("deskHand");
    const rChecked = document.getElementById("deskChecked");
    const warn = document.getElementById("deskWarn");
    const ok = document.getElementById("deskConfirm");
    const cancel = document.getElementById("deskCancel");

    if (!modal || !rHand || !rChecked || !warn || !ok || !cancel) return;

    modal.style.display = "flex";

    // Se >10kg, forÃ§a porÃ£o
    if (this.state.handWeight > 10) {
      rChecked.checked = true;
      rHand.checked = false;
      rHand.disabled = true;
      warn.textContent = "âš ï¸ Peso > 10kg: porÃ£o obrigatÃ³rio.";
    } else {
      rHand.disabled = false;
      warn.textContent = "";
    }

    const close = () => (modal.style.display = "none");

    cancel.onclick = () => {
      close();
      this.setObjective("ðŸ¢ Check-in feito. Decide a bagagem no balcÃ£o.", "checkinDesk");
    };

ok.onclick = () => {
  const wantsChecked = !!rChecked.checked;

  // reset SEMPRE
  this.state.checkedItems = [];
  this.state.checkedIn = false;

  // 1) Se escolheu "despachar" e tem mala -> mala vai para o porÃ£o
  if (wantsChecked && this.state.items.luggage) {
    this.state.checkedItems.push("luggage");
  }

  // 2) Regra peso mochila (se >10kg nÃ£o pode ir como mÃ£o => tambÃ©m vai para porÃ£o)
  // (mesmo que ele nÃ£o tenha selecionado porÃ£o para mala)
  if (this.state.items.backpack && (this.state.handWeight || 0) > 10) {
    // evita duplicados
    if (!this.state.checkedItems.includes("backpack")) {
      this.state.checkedItems.push("backpack");
    }
  }

  // 3) Se ele tem mala e NÃƒO escolheu porÃ£o, mas a mala Ã© pesada -> forÃ§a porÃ£o
  // (ajusta limite se quiseres, aqui fica 10kg para â€œcabineâ€)
  if (this.state.items.luggage && !wantsChecked && (this.state.luggageWeight || 0) > 10) {
    warn.textContent = "âš ï¸ Mala > 10kg nÃ£o pode ir em cabine. Tens de enviar para o porÃ£o.";
    rChecked.checked = true;
    rHand.checked = false;
    return;
  }

  // compatibilidade UI antiga
  this.state.hasCheckedBag = this.state.checkedItems.length > 0;

  close();
  this.updateBPUI();

  if (this.state.checkedItems.length > 0) {
    const falta = this.state.checkedItems.map(x => (x === "luggage" ? "mala" : "mochila")).join(" + ");
    this.setObjective(`ðŸ§³ Vai ao BAG DROP (cÃ­rculo roxo) e despacha: ${falta}.`, "baggageDropzone");
  } else {
    this.setObjective("ðŸ” Segue para a seguranÃ§a (cÃ­rculo verde) e completa o scanner.", "securityDropzone");
  }
};


  },

  // -------- Bag Drop: painel simples via click (roxo) ----------
onBagDropClick: function () {
  if (!this.state.started) return;

  this.state.checkedItems = this.state.checkedItems || [];

  if (this.state.checkedItems.length === 0) {
    this.setObjective("â„¹ï¸ NÃ£o tens nada para despachar no porÃ£o. Segue para a seguranÃ§a.", "securityDropzone");
    return;
  }

  this.openBagDropPanel(); // âœ… abre painel 3D
},


  // -------- Scanner modal ----------
openScannerModal: function (source = "scanner") {
  if (!this.state.started) return;

  const modal = document.getElementById("scannerModal");
  const status = document.getElementById("scanStatus");
  const btnBP = document.getElementById("btnShowBP");
  const btnBack = document.getElementById("btnScanBackpack");
  const btnPhone = document.getElementById("btnScanPhone");
  const btnLuggage = document.getElementById("btnScanLuggage");
  const btnClose = document.getElementById("btnCloseScanner");
  const btnCollect = document.getElementById("btnCollect");

  if (!modal || !status || !btnBP || !btnBack || !btnPhone || !btnLuggage || !btnClose) return;

  // garantir estrutura
  this.state.items = this.state.items || { backpack: false, phone: false, luggage: false };
  this.state.security = this.state.security || {
    boardingPassShown: false,
    scannedBackpack: false,
    scannedPhone: false,
    scannedLuggage: false,
  };

  const carry = this.getCarrySys();
  const inv = carry?.inventory || { backpack: false, phone: false, luggage: false };

  const existsBackpack = !!this.state.items.backpack;
  const existsPhone = !!this.state.items.phone;
  const existsLuggage = !!this.state.items.luggage;

  const carryBackpack = existsBackpack && !!inv.backpack;
  const carryPhone = existsPhone && !!inv.phone;
  const carryLuggage = existsLuggage && !!inv.luggage;

  // mala sÃ³ Ã© cabine se NÃƒO foi para porÃ£o (no teu projeto: checkedItems)
  const checkedItems = Array.isArray(this.state.checkedItems) ? this.state.checkedItems : [];
  const luggageInHold = checkedItems.includes("luggage");
  const needLuggage = carryLuggage && !luggageInHold;

  const needBackpack = carryBackpack;
  const needPhone = carryPhone;

  // mostrar/esconder botÃµes conforme o que faz sentido existir
  btnBack.style.display = needBackpack ? "block" : "none";
  btnPhone.style.display = needPhone ? "block" : "none";
  btnLuggage.style.display = needLuggage ? "block" : "none";

  // helper: bloquear/ativar botÃµes
  const setEnabled = (btn, enabled, hint = "") => {
    if (!btn) return;
    btn.disabled = !enabled;
    btn.style.opacity = enabled ? "1" : "0.45";
    btn.style.pointerEvents = enabled ? "auto" : "none";
    if (hint) btn.title = hint;
    else btn.removeAttribute("title");
  };

  // âœ… REGRA PRINCIPAL (separar BP vs pertences)
  const bpAlreadyShown = !!this.state.security.boardingPassShown;

  if (source === "bp") {
    // SÃ³ BP aqui
    setEnabled(btnBP, true);
    setEnabled(btnBack, false, "Para pertences, usa o SCANNER (cÃ­rculo verde).");
    setEnabled(btnPhone, false, "Para pertences, usa o SCANNER (cÃ­rculo verde).");
    setEnabled(btnLuggage, false, "Para pertences, usa o SCANNER (cÃ­rculo verde).");
  } else {
    // SÃ³ pertences aqui
    setEnabled(btnBP, false, "Para mostrar BP, usa o leitor SCAN BP.");
    // pertences sÃ³ ficam Ãºteis depois de BP mostrado (senÃ£o ficas com fluxo esquisito)
    setEnabled(btnBack, bpAlreadyShown && needBackpack);
    setEnabled(btnPhone, bpAlreadyShown && needPhone);
    setEnabled(btnLuggage, bpAlreadyShown && needLuggage);
  }

  // botÃ£o recolher
  if (btnCollect) {
    btnCollect.style.display = this.state.securityPassed ? "block" : "none";
    btnCollect.onclick = () => {
      carry?.hideWorldItems?.();
      this.setObjective("âœ… Recolheste os pertences. Segue para os gates.", null);
      modal.style.display = "none";
    };
  }

  modal.style.display = "flex";

  const refresh = () => {
    const bp = this.state.security.boardingPassShown ? "âœ…" : "â›”";
    const porao = (checkedItems.length > 0) ? (this.state.checkedIn ? "âœ…" : "â›”") : "â€”";

    const b = needBackpack ? (this.state.security.scannedBackpack ? "âœ…" : "â›”") : "â€”";
    const p = needPhone ? (this.state.security.scannedPhone ? "âœ…" : "â›”") : "â€”";
    const l = needLuggage ? (this.state.security.scannedLuggage ? "âœ…" : "â›”") : "â€”";

    // dica contextual
    const hint =
      (source === "bp")
        ? "Leitor BP: aqui sÃ³ podes mostrar o cartÃ£o."
        : (!this.state.security.boardingPassShown
            ? "Primeiro mostra o BP no leitor SCAN BP."
            : "Scanner: adiciona os pertences.");

    status.innerHTML =
      `${hint}<br/>PorÃ£o: <b>${porao}</b> â€¢ BP mostrado: <b>${bp}</b> â€¢ Mala: <b>${l}</b> â€¢ Mochila: <b>${b}</b> â€¢ TelemÃ³vel: <b>${p}</b>`;
  };

  const tryPass = () => {
    this.tryPassSecurity();
    refresh();
  };

  // --- aÃ§Ãµes ---
  btnBP.onclick = () => {
    // este botÃ£o sÃ³ Ã© clicÃ¡vel no source === "bp"
    if (!this.state.boardingPassIssued) {
      this.setObjective("ðŸŽ« Ainda nÃ£o tens BP. Faz check-in primeiro.", "checkinDeskHit");
      return;
    }
    if ((checkedItems.length > 0) && !this.state.checkedIn) {
      this.setObjective("ðŸ§³ Antes da seguranÃ§a: despacha o(s) item(ns) no BAG DROP.", "baggageDropzone");
      return;
    }

    this.state.security.boardingPassShown = true;
    this.successSound?.components?.sound?.playSound?.();
    this.updateBPUI();

    // depois de mostrar BP, se estiveres no scanner, desbloqueia pertences
    refresh();
  };

  btnBack.onclick = () => {
    if (!needBackpack) return;

    // (mantÃ©ns a tua regra do peso aqui, se quiseres)
    if ((this.state.handWeight || 0) > 10) {
      this.setObjective("â›” Mochila > 10kg nÃ£o Ã© vÃ¡lida como mÃ£o. Abre inventÃ¡rio (I) e remove.", null);
      carry?.openInventoryUI?.();
      this.state.security.scannedBackpack = false;
      this.updateBPUI();
      refresh();
      return;
    }

    this.state.security.scannedBackpack = true;
    carry?.showBackpackOnScanner?.();
    this.updateBPUI();
    tryPass();
  };

  btnPhone.onclick = () => {
    if (!needPhone) return;
    this.state.security.scannedPhone = true;
    carry?.showPhoneOnScanner?.();
    this.updateBPUI();
    tryPass();
  };

  btnLuggage.onclick = () => {
    if (!needLuggage) return;
    this.state.security.scannedLuggage = true;
    carry?.showLuggageOnScanner?.();
    this.updateBPUI();
    tryPass();
  };

  btnClose.onclick = () => (modal.style.display = "none");

  refresh();
},





tryPassSecurity: function () {
  if (this.state.securityPassed) return;

  if (!this.state.boardingPassIssued) return;
  if (this.state.hasCheckedBag && !this.state.checkedIn) return;
  if (!this.state.security.boardingPassShown) return;

  const carry = this.getCarrySys();

  const carryBackpack = !!carry?.inventory?.backpack;
  const carryPhone = !!carry?.inventory?.phone;
  const carryLuggage = !!carry?.inventory?.luggage;

  const existsBackpack = !!this.state.items.backpack;
  const existsPhone = !!this.state.items.phone;
  const existsLuggage = !!this.state.items.luggage;

  const needBackpack = existsBackpack && carryBackpack;
  const needPhone = existsPhone && carryPhone;
  const checkedItems = Array.isArray(this.state.checkedItems) ? this.state.checkedItems : [];
  const luggageInHold = checkedItems.includes("luggage");
  const needLuggage = existsLuggage && carryLuggage && !luggageInHold;


  const all =
    (!needBackpack || this.state.security.scannedBackpack) &&
    (!needPhone || this.state.security.scannedPhone) &&
    (!needLuggage || this.state.security.scannedLuggage);

  if (!all) return;

  this.passSecurity(300);
},


  passSecurity: function (delayMs = 0) {
    if (this.state.securityPassed) return;

    const doPass = () => {
      this.state.securityPassed = true;

      if (this.wall) this.wall.setAttribute("visible", "false");
      if (this.wallText) this.wallText.setAttribute("value", "");

      const gateId = this.state.gate === "A1" ? "gateA1" : this.state.gate === "A2" ? "gateA2" : "gateA3";
      this.setObjective(`âœ… SeguranÃ§a concluÃ­da! Segue para o Gate ${this.state.gate}.`, gateId);

      this.successSound?.components?.sound?.playSound?.();
      this.updateBPUI();
    };

    if (delayMs) setTimeout(doPass, delayMs);
    else doPass();
  },

  getCarrySys: function () {
    return this.el.sceneEl.components["carry-system"];
  },


openSecurityPanel: function () {
  if (!this.state.started) return;

  const panel = document.getElementById("uiSecurityPanel");
  const bpPanel = document.getElementById("uiBPPanel");
  if (bpPanel) bpPanel.setAttribute("visible", "false");
  if (!panel) return;

  panel.setAttribute("visible", "true");
  this.bindSecurityPanelButtons();
  this.refreshSecurityPanel();
},

openBPPanel: function () {
  if (!this.state.started) return;

  const panel = document.getElementById("uiBPPanel");
  const secPanel = document.getElementById("uiSecurityPanel");
  if (secPanel) secPanel.setAttribute("visible", "false");
  if (!panel) return;

  panel.setAttribute("visible", "true");
  this.bindBPPanelButtons();
  this.refreshBPPanel();
},

openDeskPanel: function () {
  if (!this.state.started) return;
  if (this.state.checkinMode !== "airport") return;

  const panel = document.getElementById("uiDeskPanel");
  if (!panel) return;

  panel.setAttribute("visible", "true");
  this.bindDeskPanelButtons();
  this.refreshDeskPanel();
},

bindDeskPanelButtons: function () {
  if (this._deskBound) return;
  this._deskBound = true;

  const btnEnter = document.getElementById("uiDeskEnter");
  const btnHand = document.getElementById("uiDeskHand");
  const btnChecked = document.getElementById("uiDeskChecked");
  const btnConfirm = document.getElementById("uiDeskConfirm");
  const btnClose = document.getElementById("uiDeskClose");

  btnClose?.addEventListener("click", () => {
    document.getElementById("uiDeskPanel")?.setAttribute("visible", "false");
  });

  // inserir dados (aqui continua a usar prompt, mas jÃ¡ dentro do painel 3D)
  btnEnter?.addEventListener("click", () => {
    const code = prompt("Insere dados: cÃ³digo de reserva / documento / nÂº do voo:");
    if (!code || code.trim().length < 4) {
      this.ui.desk.code = "";
      this.refreshDeskPanel("âš ï¸ Dados invÃ¡lidos (mÃ­n 4 chars).");
      return;
    }
    this.ui.desk.code = code.trim();
    this.refreshDeskPanel("");
  });

  btnHand?.addEventListener("click", () => {
    this.ui.desk.bagChoice = "hand";
    this.refreshDeskPanel("");
  });

  btnChecked?.addEventListener("click", () => {
    this.ui.desk.bagChoice = "checked";
    this.refreshDeskPanel("");
  });

  btnConfirm?.addEventListener("click", () => this.confirmDeskPanel());
},

refreshDeskPanel: function (forceWarn = "") {
  const codeTxt = document.getElementById("uiDeskCode");
  const warnTxt = document.getElementById("uiDeskWarn");
  const handTxt = document.getElementById("uiDeskHandTxt");
  const checkedTxt = document.getElementById("uiDeskCheckedTxt");

  if (codeTxt) codeTxt.setAttribute("value", `CÃ³digo: ${this.ui.desk.code ? this.ui.desk.code : "(vazio)"}`);

  // regra: se mochila > 10kg forÃ§a porÃ£o (mesmo que escolha mÃ£o)
  const forcedBackpack = this.state.items?.backpack && (this.state.handWeight || 0) > 10;
  const forcedWarn = forcedBackpack ? "âš ï¸ Mochila > 10kg: porÃ£o obrigatÃ³rio." : "";

  const warn = forceWarn || forcedWarn || "";
  if (warnTxt) warnTxt.setAttribute("value", warn);

  const isHand = this.ui.desk.bagChoice === "hand";
  const isChecked = this.ui.desk.bagChoice === "checked";

  // sÃ³ feedback visual
  if (handTxt) handTxt.setAttribute("value", isHand ? "âœ… MÃ£o" : "MÃ£o");
  if (checkedTxt) checkedTxt.setAttribute("value", isChecked ? "âœ… PorÃ£o" : "ðŸ§³ PorÃ£o");

  // se forÃ§ado, sobrepÃµe escolha
  if (forcedBackpack) this.ui.desk.bagChoice = "checked";
},

confirmDeskPanel: function () {
  // valida dados
  if (!this.ui.desk.code || this.ui.desk.code.trim().length < 4) {
    this.refreshDeskPanel("âš ï¸ Tens de inserir os dados primeiro.");
    return;
  }

  // marca identificado
  this.state.passengerIdentified = true;
  if (!this.state.boardingPassIssued) this.issueBoardingPass();

  // reset
  this.state.checkedItems = [];
  this.state.checkedIn = false;

  const wantsChecked = (this.ui.desk.bagChoice === "checked");

  // 1) se escolheu porÃ£o e tem mala -> mala porÃ£o
  if (wantsChecked && this.state.items?.luggage) {
    this.state.checkedItems.push("luggage");
  }

  // 2) regra mochila > 10kg -> mochila porÃ£o
  if (this.state.items?.backpack && (this.state.handWeight || 0) > 10) {
    if (!this.state.checkedItems.includes("backpack")) this.state.checkedItems.push("backpack");
  }

  // 3) regra mala â€œcabineâ€ limite 10kg (igual ao que tinhas)
  if (this.state.items?.luggage && !wantsChecked && (this.state.luggageWeight || 0) > 10) {
    this.refreshDeskPanel("âš ï¸ Mala > 10kg nÃ£o pode ir em cabine. Escolhe PorÃ£o.");
    this.ui.desk.bagChoice = "checked";
    return;
  }

  this.state.hasCheckedBag = this.state.checkedItems.length > 0;

  // fecha painel
  document.getElementById("uiDeskPanel")?.setAttribute("visible", "false");

  // objetivos
  this.updateBPUI();

  if (this.state.checkedItems.length > 0) {
    const falta = this.state.checkedItems.map(x => (x === "luggage" ? "mala" : "mochila")).join(" + ");
    this.setObjective(`ðŸ§³ Vai ao BAG DROP (cÃ­rculo roxo) e despacha: ${falta}.`, "baggageDropzone");
  } else {
    this.setObjective("ðŸ” Segue para a seguranÃ§a (cÃ­rculo verde) e completa o scanner.", "securityDropzone");
  }
},


bindSecurityPanelButtons: function () {
  if (this._secBound) return;
  this._secBound = true;

  const carry = this.getCarrySys();

  const btnBack = document.getElementById("uiBtnAddBackpack");
  const btnPhone = document.getElementById("uiBtnAddPhone");
  const btnLuggage = document.getElementById("uiBtnAddLuggage");
  const btnClose = document.getElementById("uiBtnCloseSec");

  btnClose?.addEventListener("click", () => {
    document.getElementById("uiSecurityPanel")?.setAttribute("visible", "false");
  });

  btnBack?.addEventListener("click", () => {
    // regra peso
    if ((this.state.handWeight || 0) > 10) {
      this.setObjective("â›” Mochila > 10kg. Abre inventÃ¡rio (I) e remove.", null);
      carry?.openInventoryUI?.();
      return;
    }
    if (!carry?.inventory?.backpack) return;
    this.state.security.scannedBackpack = true;
    carry?.showBackpackOnScanner?.();
    this.updateBPUI();
    this.tryPassSecurity();
    this.refreshSecurityPanel();
  });

  btnPhone?.addEventListener("click", () => {
    if (!carry?.inventory?.phone) return;
    this.state.security.scannedPhone = true;
    carry?.showPhoneOnScanner?.();
    this.updateBPUI();
    this.tryPassSecurity();
    this.refreshSecurityPanel();
  });

  btnLuggage?.addEventListener("click", () => {
    // sÃ³ se for cabine
    const checkedItems = Array.isArray(this.state.checkedItems) ? this.state.checkedItems : [];
    const luggageInHold = checkedItems.includes("luggage");
    if (luggageInHold) return;

    if (!carry?.inventory?.luggage) return;
    this.state.security.scannedLuggage = true;
    carry?.showLuggageOnScanner?.();
    this.updateBPUI();
    this.tryPassSecurity();
    this.refreshSecurityPanel();
  });
},

refreshSecurityPanel: function () {
  const t = document.getElementById("uiSecStatus");
  if (!t) return;

  const carry = this.getCarrySys();
  const checkedItems = Array.isArray(this.state.checkedItems) ? this.state.checkedItems : [];
  const porao = (checkedItems.length > 0) ? (this.state.checkedIn ? "âœ…" : "â›”") : "â€”";

  const b = (this.state.items.backpack && carry?.inventory?.backpack) ? (this.state.security.scannedBackpack ? "âœ…" : "â›”") : "â€”";
  const p = (this.state.items.phone && carry?.inventory?.phone) ? (this.state.security.scannedPhone ? "âœ…" : "â›”") : "â€”";

  const luggageInHold = checkedItems.includes("luggage");
  const l = (this.state.items.luggage && carry?.inventory?.luggage && !luggageInHold) ? (this.state.security.scannedLuggage ? "âœ…" : "â›”") : "â€”";

  t.setAttribute("value", `PorÃ£o: ${porao}\nMochila: ${b}  TelemÃ³vel: ${p}\nMala(cabine): ${l}`);
},

bindBPPanelButtons: function () {
  if (this._bpBound) return;
  this._bpBound = true;

  const btnShow = document.getElementById("uiBtnShowBP");
  const btnClose = document.getElementById("uiBtnCloseBP");

  btnClose?.addEventListener("click", () => {
    document.getElementById("uiBPPanel")?.setAttribute("visible", "false");
  });

  btnShow?.addEventListener("click", () => {
    if (!this.state.boardingPassIssued) {
      this.setObjective("ðŸŽ« Ainda nÃ£o tens BP. Faz check-in primeiro.", "checkinDeskHit");
      return;
    }

    const checkedItems = Array.isArray(this.state.checkedItems) ? this.state.checkedItems : [];
    if (checkedItems.length > 0 && !this.state.checkedIn) {
      this.setObjective("ðŸ§³ Antes: despacha no BAG DROP.", "baggageDropzone");
      return;
    }

    this.state.security.boardingPassShown = true;
    this.successSound?.components?.sound?.playSound?.();
    this.updateBPUI();
    this.refreshBPPanel();
  });
},

refreshBPPanel: function () {
  const t = document.getElementById("uiBPStatus");
  if (!t) return;
  const ok = this.state.security.boardingPassShown ? "âœ…" : "â›”";
  t.setAttribute("value", `BP mostrado: ${ok}`);
},



});

AFRAME.registerComponent("carry-system", {
  init: function () {
    console.log("[carry-system] INIT");

    this.inventory = { backpack: false, phone: false, luggage: false };
    this.exists = { backpack: false, phone: false, luggage: false };

    this.spawn = {
      backpack: { x: 3.35, y: 0, z: 20.866 },
      luggage:  { x: 3.0,  y: 0, z: 20.866 },
      phone:    { x: 3.7,  y: 0, z: 20.866 },
    };

    this._ready = false;
    this._inv3DBound = false;
    this._keyBound = false;
    this._setupTries = 0;

    const scene = this.el.sceneEl;
    if (scene.hasLoaded) this.trySetup();
    else scene.addEventListener("loaded", () => this.trySetup());
  },

  trySetup: function () {
    this._setupTries++;

    this.backpack = document.getElementById("backpack");
    this.luggage  = document.getElementById("luggage");
    this.phone    = document.getElementById("phone");

    this.securityDropzone = document.getElementById("securityDropzone");
    this.player = document.getElementById("player");
    this.cam    = document.getElementById("cam");

    // UI InventÃ¡rio 3D (no A-SCENE, NÃƒO parented Ã  cÃ¢mara)
    this.invPanel = document.getElementById("uiInvPanel");
    this.invHint  = document.getElementById("uiInvHint");

    this.invBtnBackpack = document.getElementById("uiInvBackpack");
    this.invBtnPhone    = document.getElementById("uiInvPhone");
    this.invBtnLuggage  = document.getElementById("uiInvLuggage");

    this.invTxtBackpack = document.getElementById("uiInvBackpackTxt");
    this.invTxtPhone    = document.getElementById("uiInvPhoneTxt");
    this.invTxtLuggage  = document.getElementById("uiInvLuggageTxt");

    if (!this.cam || !this.invPanel) {
      if (this._setupTries < 160) return setTimeout(() => this.trySetup(), 50);
      console.error("[carry-system] setup failed: cam or uiInvPanel not found");
      return;
    }

    if (this._ready) return;
    this._ready = true;

    // estado inicial do painel
    this.invPanel.setAttribute("visible", "false");
    this.invPanel.setAttribute("rotation", "0 0 0");
    this.invPanel.setAttribute("scale", "1 1 1");

    // itens no mundo clicÃ¡veis
    this.backpack?.classList.add("clickable");
    this.luggage?.classList.add("clickable");
    this.phone?.classList.add("clickable");

    this.backpack?.addEventListener("click", () => this.pickUp("backpack"));
    this.luggage?.addEventListener("click", () => this.pickUp("luggage"));
    this.phone?.addEventListener("click", () => this.pickUp("phone"));

    this.bindInventoryPanelButtons();

    // Tecla I (uma vez). Ignora auto-repeat.
    if (!this._keyBound) {
      this._keyBound = true;
      window.addEventListener("keydown", (e) => {
        if (e.repeat) return;
        if (e.key === "i" || e.key === "I") {
          console.log("[carry-system] KeyI pressed");
          this.toggleInventoryUI();
        }
      });
    }

    this.hideWorldItems();
    this.refreshInventoryPanel();
  },

  // chamado no flowStart
  syncFromFlowState: function (wfState) {
    const items = wfState?.items || { backpack: false, phone: false, luggage: false };

    this.exists.backpack = !!items.backpack;
    this.exists.phone    = !!items.phone;
    this.exists.luggage  = !!items.luggage;

    this.inventory.backpack = this.exists.backpack;
    this.inventory.phone    = this.exists.phone;
    this.inventory.luggage  = this.exists.luggage;

    this.hideWorldItems();
    this.refreshInventoryPanel();
  },

  hideWorldItems: function () {
    this.backpack?.setAttribute("visible", "false");
    this.luggage?.setAttribute("visible", "false");
    this.phone?.setAttribute("visible", "false");
  },

  // ---------- INVENTÃRIO UI (crÃ­tico)
  toggleInventoryUI: function () {
    if (!this.invPanel) return;
    const v = this.invPanel.getAttribute("visible");
    const open = (v === true || v === "true");
    if (open) this.closeInventoryUI();
    else this.openInventoryUI();
  },

  openInventoryUI: function () {
    if (!this.invPanel || !this.cam) return;

    this.refreshInventoryPanel();

    // âœ… Coloca o painel NO MUNDO, uma vez, perto do jogador (nÃ£o fica colado Ã  cÃ¢mara)
    const camObj = this.cam.object3D;

    const camPos = camObj.getWorldPosition(new THREE.Vector3());
    const q = camObj.quaternion;

    const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(q);
    const right   = new THREE.Vector3(1, 0, 0).applyQuaternion(q);

    // Ã  frente e um bocado ao lado (tipo "ao teu lado", como quando dropas items)
    const pos = camPos.clone()
      .add(forward.multiplyScalar(1.15))
      .add(right.multiplyScalar(0.38));

    pos.y -= 0.25;

    this.invPanel.setAttribute("position", `${pos.x} ${pos.y} ${pos.z}`);

    // olha para a cÃ¢mara, mas NÃƒO reposiciona a cada frame
    this.invPanel.object3D.lookAt(camPos);
    this.invPanel.object3D.rotation.x = 0;
    this.invPanel.object3D.rotation.z = 0;

    this.invPanel.setAttribute("visible", "true");
  },

  closeInventoryUI: function () {
    if (!this.invPanel) return;
    this.invPanel.setAttribute("visible", "false");
  },

  // ---------- DROP / PICKUP
  drop: function (id) {
    if (!this.exists[id]) return;
    this.inventory[id] = false;

    const wf = this.el.sceneEl.components.wayfinding;
    if (wf?.state?.security) {
      if (id === "backpack") wf.state.security.scannedBackpack = false;
      if (id === "phone")    wf.state.security.scannedPhone = false;
      if (id === "luggage")  wf.state.security.scannedLuggage = false;
      wf.updateBPUI?.();
    }

    const el = this[id];
    if (!el) return this.refreshInventoryPanel();

    const camEl = this.cam || document.getElementById("cam");
    if (camEl) {
      const p = camEl.object3D.getWorldPosition(new THREE.Vector3());
      const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(camEl.object3D.quaternion);

      const dx = p.x + forward.x * 0.9;
      const dz = p.z + forward.z * 0.9;

      el.setAttribute("position", `${dx} 0 ${dz}`);
      el.setAttribute("visible", "true");
    } else {
      const s = this.spawn[id];
      if (s) el.setAttribute("position", `${s.x} ${s.y} ${s.z}`);
      el.setAttribute("visible", "true");
    }

    this.refreshInventoryPanel();
  },

  pickUp: function (id) {
    if (!this.exists[id]) return;
    this.inventory[id] = true;
    this[id]?.setAttribute("visible", "false");
    this.refreshInventoryPanel();
  },

  removeForever: function (id) {
    this.inventory[id] = false;
    this.exists[id] = false;
    this[id]?.setAttribute("visible", "false");
    this.refreshInventoryPanel();
  },

  // ---------- SEGURANÃ‡A
  showBackpackOnScanner: function () {
    if (!this.backpack || !this.securityDropzone) return;
    if (!this.inventory.backpack) return;
    const dz = this.securityDropzone.getAttribute("position");
    this.backpack.setAttribute("position", `${dz.x - 0.25} ${dz.y - 0.1} ${dz.z - 2.5}`);
    this.backpack.setAttribute("rotation", "0 180 0");
    this.backpack.setAttribute("visible", "true");
  },

  showLuggageOnScanner: function () {
    if (!this.luggage || !this.securityDropzone) return;
    if (!this.inventory.luggage) return;
    const dz = this.securityDropzone.getAttribute("position");
    this.luggage.setAttribute("position", `${dz.x + 0.35} ${dz.y - 0.1} ${dz.z - 2.5}`);
    this.luggage.setAttribute("rotation", "0 180 0");
    this.luggage.setAttribute("visible", "true");
  },

  showPhoneOnScanner: function () {
    if (!this.phone || !this.securityDropzone) return;
    if (!this.inventory.phone) return;
    const dz = this.securityDropzone.getAttribute("position");
    this.phone.setAttribute("position", `${dz.x} ${dz.y - 0.1} ${dz.z - 1.6}`);
    this.phone.setAttribute("rotation", "0 180 0");
    this.phone.setAttribute("visible", "true");
  },

  snapBackpackToScanner: function () { this.showBackpackOnScanner(); },
  snapPhoneToScanner: function () { this.showPhoneOnScanner(); },

  // ---------- BOTÃ•ES DO PAINEL
  bindInventoryPanelButtons: function () {
    if (this._inv3DBound) return;
    this._inv3DBound = true;

    const handle = (id) => {
      if (!this.exists[id]) return;
      if (this.inventory[id]) this.drop(id);
      else this.pickUp(id);
    };

    this.invBtnBackpack?.addEventListener("click", () => handle("backpack"));
    this.invBtnPhone?.addEventListener("click", () => handle("phone"));
    this.invBtnLuggage?.addEventListener("click", () => handle("luggage"));
  },

  refreshInventoryPanel: function () {
    if (!this.invPanel) return;

    const line = (id, label) => {
      if (!this.exists[id]) return `${label}: (nÃ£o existe)`;
      return this.inventory[id]
        ? `${label}: âœ… no inventÃ¡rio (clicar para remover)`
        : `${label}: â›” fora (clicar para adicionar)`;
    };

    this.invTxtBackpack?.setAttribute("value", line("backpack", "ðŸŽ’ Mochila"));
    this.invTxtPhone?.setAttribute("value", line("phone", "ðŸ“± TelemÃ³vel"));
    this.invTxtLuggage?.setAttribute("value", line("luggage", "ðŸ§³ Mala"));

    const eb = !!this.exists.backpack;
    const ep = !!this.exists.phone;
    const el = !!this.exists.luggage;

    this.invBtnBackpack?.setAttribute("visible", eb);
    this.invTxtBackpack?.setAttribute("visible", eb);

    this.invBtnPhone?.setAttribute("visible", ep);
    this.invTxtPhone?.setAttribute("visible", ep);

    this.invBtnLuggage?.setAttribute("visible", el);
    this.invTxtLuggage?.setAttribute("visible", el);
  },
});










</script>


    <style>
      html, body { margin: 0; height: 100%; overflow: hidden; }
      #hud {
        position: fixed; left: 12px; top: 12px; z-index: 10;
        background: rgba(0,0,0,.6); color: #fff; padding: 10px 12px;
        border-radius: 12px; font-family: system-ui, sans-serif; font-size: 14px;
      }

      .modal{
        position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
        background:rgba(0,0,0,.55); z-index:9999;
        font-family:system-ui,sans-serif;
      }
      .modal-card{
        width:min(520px, calc(100% - 24px));
        background:#111; color:#fff; padding:16px; border-radius:14px;
        border:1px solid rgba(255,255,255,.12);
      }
      .modal-card h3{ margin:0 0 8px 0; font-size:18px; }
      .modal-card p{ margin:8px 0; color:rgba(255,255,255,.85); }
      .modal-card .row{ display:flex; gap:10px; margin-top:10px; }
      .modal-card button{
        flex:1; padding:10px 12px; border-radius:10px;
        border:0; cursor:pointer; font-weight:600;
      }
      #btnOnline{ background:#2ecc71; }
      #btnCounter{ background:#f1c40f; }
      .hint{ font-size:12px; opacity:.75; margin-top:10px; }

      .bp{
        position:fixed; right:12px; top:12px; z-index:11;
        width:320px; background:rgba(0,0,0,.65); color:#fff;
        padding:12px; border-radius:12px; font-family:system-ui,sans-serif;
        border:1px solid rgba(255,255,255,.12);
      }
      .bp-title{ font-weight:700; margin-bottom:6px; }
      .bp-line{ font-size:13px; opacity:.95; margin-top:4px; }

      @media (max-width: 520px){
        .bp{ width: calc(100% - 24px); left: 12px; right: 12px; top: auto; bottom: 12px; }
        #hud{ right: 12px; }
      }


    </style>
  </head>

  <body>
    <div id="hud">
      <b>Aeroporto VR</b><br />WASD â€¢ Rato
      <br/><span id="hudTarget">Entra no aeroporto e faz Check-in.</span>
    </div>

  <div id="boardingPass" class="bp" style="display:none;">
    <div class="bp-title">ðŸŽ« CartÃ£o de Embarque</div>
    <div id="bpLine1" class="bp-line">Gate: â€” | Destino: â€”</div>
    <div id="bpLine2" class="bp-line">
      BP: â›” â€¢ Bagagem: â›” â€¢ Etiqueta: â€” â€¢ Drop-off: â€” â€¢ SeguranÃ§a: â›”
    </div>

  </div>

    <!-- Modal: Check-in (inicial) -->
  <div id="flowModal" class="modal" style="display:none;">
    <div class="modal-card">
      <h3>âœˆï¸ Check-in</h3>

      <p><b>Modo</b></p>
      <div class="row">
        <button id="mOnline">âœ… Online</button>
        <button id="mAirport">ðŸ¢ No aeroporto</button>
      </div>

      <hr style="opacity:.15; margin:12px 0">

      <p><b>Bagagem de mÃ£o</b> (ex: mochila)</p>
      <label style="display:flex; gap:8px; align-items:center;">
        Peso:
        <input id="handWeight" type="number" min="0" step="0.1" value="6" style="margin-left:auto; width:90px;">
        <span style="opacity:.75;">kg</span>
      </label>
      <p class="hint">Regra: bagagem de mÃ£o tem de ser â‰¤ <b>10kg</b> (senÃ£o Ã© obrigatÃ³rio porÃ£o).</p>

      <div id="onlineExtra" style="display:none;">
        <hr style="opacity:.15; margin:12px 0">
        <p><b>(Online) Queres despachar bagagem de porÃ£o?</b></p>
        <label style="display:flex; gap:8px; align-items:center;">
          <input type="checkbox" id="onlineChecked">
          Sim, vou despachar uma mala no porÃ£o
        </label>
      </div>

      <div style="margin-top:8px;">
        <label style="font-size:13px; opacity:.85;">Peso da mala (kg)</label>
        <input id="luggageWeight" type="number" min="0" step="0.1" value="0"
              style="width:100%; padding:8px; border-radius:10px; border:0; margin-top:6px;">
      </div>


      <hr style="opacity:.15; margin:12px 0">
      <p><b>Pertences</b> (comeÃ§am no inventÃ¡rio)</p>

      <label style="display:flex; gap:8px; align-items:center; margin:6px 0;">
        <input type="checkbox" id="hasBackpack" checked>
        ðŸŽ’ Mochila
      </label>

      <label style="display:flex; gap:8px; align-items:center; margin:6px 0;">
        <input type="checkbox" id="hasPhone" checked>
        ðŸ“± TelemÃ³vel
      </label>

      <label style="display:flex; gap:8px; align-items:center; margin:6px 0;">
        <input type="checkbox" id="hasLuggage">
        ðŸ§³ Mala (pode ser porÃ£o)
      </label>


      <div class="row" style="margin-top:12px;">
        <button id="flowStart" style="background:#3498db; color:#fff;">â–¶ï¸ ComeÃ§ar</button>
      </div>

      <p id="flowWarn" class="hint" style="color:#ffcc66;"></p>
    </div>
  </div>

  <!-- Modal: BalcÃ£o (sÃ³ airport) -->
  <div id="deskModal" class="modal" style="display:none;">
    <div class="modal-card">
      <h3>ðŸ¢ BalcÃ£o de Check-in</h3>
      <p>Confirmar bagagem:</p>

      <label style="display:flex; gap:8px; align-items:center; margin:6px 0;">
        <input type="radio" name="deskBag" id="deskHand" checked>
        Vou apenas com bagagem de mÃ£o
      </label>
      <label style="display:flex; gap:8px; align-items:center; margin:6px 0;">
        <input type="radio" name="deskBag" id="deskChecked">
        Vou despachar uma mala no porÃ£o
      </label>

      <p id="deskWarn" class="hint" style="color:#ffcc66;"></p>

      <div class="row" style="margin-top:12px;">
        <button id="deskConfirm" style="background:#2ecc71;">âœ… Confirmar</button>
        <button id="deskCancel" style="background:#95a5a6;">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Scanner (seguranÃ§a) -->
  <div id="scannerModal" class="modal" style="display:none;">
    <div class="modal-card">
      <h3>ðŸ” SeguranÃ§a â€” Scanner</h3>

      <div id="scanStatus" class="hint"></div>

      <div class="row" style="margin-top:10px;">
        <button id="btnShowBP" style="background:#2ecc71;">ðŸŽ« Mostrar BP</button>
        <button id="btnScanBackpack" style="background:#f1c40f;">ðŸŽ’ Adicionar mochila</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="btnScanPhone" style="background:#f39c12;">ðŸ“± Adicionar telemÃ³vel</button>
        <button id="btnScanLuggage">ðŸ§³ Mala</button>
        <button id="btnCloseScanner" style="background:#95a5a6;">Fechar</button>
      </div>

      <p class="hint" style="margin-top:10px;">
        Dica: tens de â€œmostrar BPâ€ e adicionar todos os pertences para poderes passar.
      </p>

      <button id="btnCollect" style="background:#3498db;">ðŸŽ’ Recolher pertences</button>

    </div>
  </div>


  <div id="bagDropModal" class="modal" style="display:none;">
  <div class="modal-card">
    <h3>ðŸ§³ Bag Drop</h3>
    <p id="bagDropInfo" class="hint"></p>
    <div class="row" style="margin-top:12px;">
      <button id="bagDropConfirm" style="background:#8e44ad; color:#fff;">âœ… Despachar mala</button>
      <button id="bagDropClose" style="background:#95a5a6;">Fechar</button>
    </div>
  </div>
</div>




    <a-scene wayfinding carry-system audio-unlock
         renderer="colorManagement: true; physicallyCorrectLights: true;"
         shadow="type: pcfsoft">
      <a-sky id="main-sky" color="#87CEEB"></a-sky>


      <a-assets>
        <img id="chao-tex" src="chao2.jpg">
        <img id="parede-tex" src="parede.jpg">
        <img id="asfalto-tex" src="https://cdn.aframe.io/a-painter/images/floor.jpg">

        <a-asset-item id="modelo-mala" src="luggage.glb"></a-asset-item>
        <a-asset-item id="modelo-backpack" src="backpack.glb"></a-asset-item>
        <a-asset-item id="modelo-balcao" src="airport_check_in_desk.glb"></a-asset-item>
        <a-asset-item id="modelo-security" src="airport_security_check.glb"></a-asset-item>
        <a-asset-item id="modelo-iphone" src="iphone.glb"></a-asset-item>


        <!-- NOVOS MODELOS -->
        <a-asset-item id="modelo-cadeira" src="waiting_chair.glb"></a-asset-item>
        <a-asset-item id="modelo-gate-sign" src="airport_boarding_gate_sign.glb"></a-asset-item>

        <audio id="airportAmbience"
       src="https://cdn.pixabay.com/download/audio/2022/03/24/audio_3079b47e40.mp3"
       preload="auto"
       crossorigin="anonymous"></audio>

        <audio id="successClip"
              src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_0625c153e1.mp3"
              preload="auto"
              crossorigin="anonymous"></audio>

        <audio id="scannerSfx" src="scannerSound.wav" preload="auto"></audio>

      </a-assets>

      

      <a-entity id="ambience" sound="src: #airportAmbience; autoplay: true; loop: true; volume: 0.5"></a-entity>

      <a-entity id="soundSuccess" sound="src: #successClip; volume: 1.0; poolSize: 5"></a-entity>

      <a-entity light="type: directional; castShadow: true; intensity: 1.5; shadowCameraVisible: false;"
                position="-20 50 -20" target="#directionaltarget">
        <a-entity id="directionaltarget" position="0 0 0"></a-entity>
      </a-entity>
      <a-entity light="type: ambient; intensity: 0.6; color: #fff"></a-entity>

      <a-entity id="player" position="0 0 25">
        <a-camera id="cam" position="0 1.6 0"
                  wasd-controls="acceleration: 50"
                  look-controls="pointerLockEnabled: true; mouseSensitivity: 0.06">
          <a-cursor raycaster="objects: .clickable" fuse="false" material="color: white; shader: flat"></a-cursor>
        </a-camera>
      </a-entity>


      <a-entity id="uiInvPanel"
          visible="false"
          rotation="0 0 0" face-camera>

      <a-plane width="1.9" height="1.15" color="#111"
              material="opacity:0.88; transparent:true"></a-plane>

      <a-text value="ðŸŽ’ INVENTÃRIO"
              position="0 0.45 0.01"
              align="center" width="2.8" color="#fff"></a-text>

      <a-text id="uiInvHint"
              value="I para fechar"
              position="0 0.32 0.01"
              align="center" width="2.4" color="#bdbdbd"></a-text>

      <!-- Mochila -->
      <a-plane id="uiInvBackpack" class="clickable"
              position="0 0.12 0.01" width="1.55" height="0.20"
              color="#2c3e50"></a-plane>
      <a-text id="uiInvBackpackTxt"
              value="ðŸŽ’ Mochila: â€”"
              position="0 0.12 0.02" align="center" width="3.0" color="#fff"></a-text>

      <!-- TelemÃ³vel -->
      <a-plane id="uiInvPhone" class="clickable"
              position="0 -0.12 0.01" width="1.55" height="0.20"
              color="#2c3e50"></a-plane>
      <a-text id="uiInvPhoneTxt"
              value="ðŸ“± TelemÃ³vel: â€”"
              position="0 -0.12 0.02" align="center" width="3.0" color="#fff"></a-text>

      <!-- Mala -->
      <a-plane id="uiInvLuggage" class="clickable"
              position="0 -0.36 0.01" width="1.55" height="0.20"
              color="#2c3e50"></a-plane>
      <a-text id="uiInvLuggageTxt"
              value="ðŸ§³ Mala: â€”"
              position="0 -0.36 0.02" align="center" width="3.0" color="#fff"></a-text>

    </a-entity>


        <a-entity id="uiFlowPanel"
          position="0 1.7 23"
          rotation="0 180 0"
          visible="true"
          face-camera>

        <a-plane width="2.2" height="1.55" color="#111"
                material="opacity:0.88; transparent:true"></a-plane>

        <a-text value="CHECK-IN" position="0 0.68 0.01"
                align="center" width="3.2" color="#fff"></a-text>

        <!-- MODO -->
        <a-text value="Modo" position="-0.95 0.45 0.01"
                align="left" width="2.6" color="#d0d0d0"></a-text>

        <a-plane id="uiModeOnline" class="clickable"
                position="-0.55 0.28 0.01" width="0.95" height="0.20"
                color="#2ecc71"></a-plane>
        <a-text value="âœ… Online" position="-0.55 0.28 0.02"
                align="center" width="2.4" color="#111"></a-text>

        <a-plane id="uiModeAirport" class="clickable"
                position="0.55 0.28 0.01" width="0.95" height="0.20"
                color="#f1c40f"></a-plane>
        <a-text value="ðŸ¢ Aeroporto" position="0.55 0.28 0.02"
                align="center" width="2.4" color="#111"></a-text>

        <!-- PERTENCES -->
        <a-text value="Pertences" position="-0.95 0.06 0.01"
                align="left" width="2.6" color="#d0d0d0"></a-text>

        <a-plane id="uiHasBackpack" class="clickable"
                position="-0.62 -0.12 0.01" width="0.75" height="0.18"
                color="#34495e"></a-plane>
        <a-text id="uiHasBackpackTxt" value="ðŸŽ’ Mochila: SIM"
                position="-0.62 -0.12 0.02" align="center"
                width="2.2" color="#fff"></a-text>

        <a-plane id="uiHasPhone" class="clickable"
                position="0.18 -0.12 0.01" width="0.75" height="0.18"
                color="#34495e"></a-plane>
        <a-text id="uiHasPhoneTxt" value="ðŸ“± TelemÃ³vel: SIM"
                position="0.18 -0.12 0.02" align="center"
                width="2.2" color="#fff"></a-text>

        <a-plane id="uiHasLuggage" class="clickable"
                position="0.98 -0.12 0.01" width="0.75" height="0.18"
                color="#34495e"></a-plane>
        <a-text id="uiHasLuggageTxt" value="ðŸ§³ Mala: NÃƒO"
                position="0.98 -0.12 0.02" align="center"
                width="2.2" color="#fff"></a-text>

        <!-- PESOS (botÃµes +/-) -->
        <a-text id="uiHandWLabel" value="Peso mochila: 6.0kg"
                position="-0.95 -0.38 0.01" align="left"
                width="3.0" color="#d0d0d0"></a-text>

        <a-plane id="uiHandMinus" class="clickable"
                position="0.45 -0.38 0.01" width="0.18" height="0.18"
                color="#95a5a6"></a-plane>
        <a-text value="-" position="0.45 -0.38 0.02" align="center" width="2" color="#111"></a-text>

        <a-plane id="uiHandPlus" class="clickable"
                position="0.68 -0.38 0.01" width="0.18" height="0.18"
                color="#95a5a6"></a-plane>
        <a-text value="+" position="0.68 -0.38 0.02" align="center" width="2" color="#111"></a-text>

        <a-text id="uiLuggWLabel" value="Peso mala: 0.0kg"
                position="-0.95 -0.58 0.01" align="left"
                width="3.0" color="#d0d0d0"></a-text>

        <a-plane id="uiLuggMinus" class="clickable"
                position="0.45 -0.58 0.01" width="0.18" height="0.18"
                color="#95a5a6"></a-plane>
        <a-text value="-" position="0.45 -0.58 0.02" align="center" width="2" color="#111"></a-text>

        <a-plane id="uiLuggPlus" class="clickable"
                position="0.68 -0.58 0.01" width="0.18" height="0.18"
                color="#95a5a6"></a-plane>
        <a-text value="+" position="0.68 -0.58 0.02" align="center" width="2" color="#111"></a-text>

        <!-- CHECK (sÃ³ online) -->
        <a-plane id="uiOnlineChecked" class="clickable"
                position="-0.55 -0.80 0.01" width="2.0" height="0.18"
                color="#2c3e50"></a-plane>
        <a-text id="uiOnlineCheckedTxt" value="(Online) Despachar mala: NÃƒO"
                position="-0.55 -0.80 0.02" align="center" width="3.4" color="#fff"></a-text>

        <!-- WARN -->
        <a-text id="uiFlowWarn" value=""
                position="0 -0.98 0.01" align="center" width="3.2"
                color="#ffcc66"></a-text>

        <!-- START -->
        <a-plane id="uiFlowStart" class="clickable"
                position="0 -1.18 0.01" width="1.6" height="0.22"
                color="#3498db"></a-plane>
        <a-text value="â–¶ï¸ COMEÃ‡AR"
                position="0 -1.18 0.02" align="center" width="3.0" color="#fff"></a-text>

      </a-entity>


      <!-- Painel 3D: BAG DROP (aparece ao clicar no cÃ­rculo roxo) -->
      <a-entity id="uiBagDropPanel"
                position="3.516 1.55 17.25"
                rotation="0 270 0"
                visible="false"
                face-camera>

        <a-plane width="1.7" height="1.05" color="#111"
                material="opacity:0.88; transparent:true"></a-plane>

        <a-text value="BAG DROP" position="0 0.40 0.01"
                align="center" width="2.4" color="#fff"></a-text>

        <a-text id="uiBagDropStatus" value="..."
                position="0 0.18 0.01"
                align="center" width="2.2" color="#d0d0d0"></a-text>

        <!-- botÃµes por item -->
        <a-plane id="uiDropLuggage" class="clickable"
                position="0 0.00 0.01" width="1.35" height="0.18"
                color="#bdc3c7"></a-plane>
        <a-text id="uiDropLuggageTxt" value="ðŸ§³ Despachar mala"
                position="0 0.00 0.02" align="center" width="2.4" color="#111"></a-text>

        <a-plane id="uiDropBackpack" class="clickable"
                position="0 -0.22 0.01" width="1.35" height="0.18"
                color="#f1c40f"></a-plane>
        <a-text id="uiDropBackpackTxt" value="ðŸŽ’ Despachar mochila"
                position="0 -0.22 0.02" align="center" width="2.4" color="#111"></a-text>

        <a-plane id="uiBagDropClose" class="clickable"
                position="0 -0.44 0.01" width="1.35" height="0.16"
                color="#95a5a6"></a-plane>
        <a-text value="Fechar"
                position="0 -0.44 0.02" align="center" width="2.0" color="#111"></a-text>

      </a-entity>

      <!-- Painel 3D: BalcÃ£o de Check-in (modo aeroporto) -->
      <a-entity id="uiDeskPanel"
                position="5.45 1.75 16.6"
                rotation="0 270 0"
                visible="false">

        <a-plane width="1.85" height="1.25" color="#111"
                material="opacity:0.88; transparent:true"></a-plane>

        <a-text value="BALCÃƒO CHECK-IN"
                position="0 0.50 0.01"
                align="center" width="2.6" color="#fff"></a-text>

        <!-- Input visual (mostra o que foi â€œdigitadoâ€) -->
        <a-text id="uiDeskCode"
                value="CÃ³digo: (vazio)"
                position="0 0.28 0.01"
                align="center" width="2.6" color="#d0d0d0"></a-text>

        <!-- BotÃ£o â€œInserir dadosâ€ -->
        <a-plane id="uiDeskEnter" class="clickable"
                position="0 0.05 0.01"
                width="1.35" height="0.18"
                color="#3498db"></a-plane>
        <a-text value="âŒ¨ï¸ Inserir dados"
                position="0 0.05 0.02"
                align="center" width="2.6" color="#fff"></a-text>

        <!-- Escolha de bagagem -->
        <a-text value="Bagagem:"
                position="-0.78 -0.18 0.01"
                align="left" width="2.2" color="#d0d0d0"></a-text>

        <a-plane id="uiDeskHand" class="clickable"
                position="-0.45 -0.36 0.01"
                width="0.85" height="0.18"
                color="#2ecc71"></a-plane>
        <a-text id="uiDeskHandTxt" value="âœ… MÃ£o"
                position="-0.45 -0.36 0.02"
                align="center" width="2.0" color="#111"></a-text>

        <a-plane id="uiDeskChecked" class="clickable"
                position="0.45 -0.36 0.01"
                width="0.85" height="0.18"
                color="#f1c40f"></a-plane>
        <a-text id="uiDeskCheckedTxt" value="ðŸ§³ PorÃ£o"
                position="0.45 -0.36 0.02"
                align="center" width="2.0" color="#111"></a-text>

        <!-- Avisos -->
        <a-text id="uiDeskWarn"
                value=""
                position="0 -0.58 0.01"
                align="center" width="2.6" color="#ffcc66"></a-text>

        <!-- Confirmar -->
        <a-plane id="uiDeskConfirm" class="clickable"
                position="0 -0.80 0.01"
                width="1.35" height="0.18"
                color="#2ecc71"></a-plane>
        <a-text value="âœ… Confirmar"
                position="0 -0.80 0.02"
                align="center" width="2.4" color="#111"></a-text>

        <!-- Fechar -->
        <a-plane id="uiDeskClose" class="clickable"
                position="0 -0.98 0.01"
                width="1.35" height="0.16"
                color="#95a5a6"></a-plane>
        <a-text value="Fechar"
                position="0 -0.98 0.02"
                align="center" width="2.2" color="#111"></a-text>

      </a-entity>



        <!-- Painel 3D: SeguranÃ§a (aparece ao clicar no scanner) -->
        <a-entity id="uiSecurityPanel"
                  position="2.738 1.826 2.896"
                  rotation="0 0 0"
                  visible="false">

          <!-- fundo -->
          <a-plane width="1.6" height="1.1" color="#111" material="opacity:0.85; transparent:true"></a-plane>

          <a-text value="SEGURANÃ‡A" position="0 0.45 0.01" align="center" width="2.4" color="#fff"></a-text>

          <!-- status -->
          <a-text id="uiSecStatus" value="..." position="0 0.25 0.01" align="center" width="2.2" color="#d0d0d0"></a-text>

          <!-- botÃµes -->
          <a-plane class="clickable" id="uiBtnAddBackpack"
                  position="-0.45 -0.05 0.01" width="0.7" height="0.18"
                  color="#f1c40f"></a-plane>
          <a-text value="ðŸŽ’ Mochila" position="-0.45 -0.05 0.02" align="center" width="2" color="#111"></a-text>

          <a-plane class="clickable" id="uiBtnAddPhone"
                  position="0.45 -0.05 0.01" width="0.7" height="0.18"
                  color="#f39c12"></a-plane>
          <a-text value="ðŸ“± TelemÃ³vel" position="0.45 -0.05 0.02" align="center" width="2" color="#111"></a-text>

          <a-plane class="clickable" id="uiBtnAddLuggage"
                  position="0 -0.32 0.01" width="1.2" height="0.18"
                  color="#bdc3c7"></a-plane>
          <a-text value="ðŸ§³ Mala (cabine)" position="0 -0.32 0.02" align="center" width="2.4" color="#111"></a-text>

          <a-plane class="clickable" id="uiBtnCloseSec"
                  position="0 -0.52 0.01" width="1.2" height="0.16"
                  color="#95a5a6"></a-plane>
          <a-text value="Fechar" position="0 -0.52 0.02" align="center" width="2" color="#111"></a-text>

        </a-entity>


        <!-- Painel 3D: BP (aparece ao clicar no bpReader) -->
        <a-entity id="uiBPPanel"
                  position="5.372 1.5 1.6"
                  rotation="0 0 0"
                  visible="false">

          <a-plane width="1.4" height="0.7" color="#111" material="opacity:0.85; transparent:true"></a-plane>
          <a-text value="CARTÃƒO DE EMBARQUE" position="0 0.22 0.01" align="center" width="2.4" color="#fff"></a-text>
          <a-text id="uiBPStatus" value="..." position="0 0.05 0.01" align="center" width="2.2" color="#d0d0d0"></a-text>

          <a-plane class="clickable" id="uiBtnShowBP"
                  position="0 -0.18 0.01" width="1.1" height="0.18"
                  color="#2ecc71"></a-plane>
          <a-text value="ðŸŽ« Mostrar BP" position="0 -0.18 0.02" align="center" width="2.2" color="#111"></a-text>

          <a-plane class="clickable" id="uiBtnCloseBP"
                  position="0 -0.38 0.01" width="1.1" height="0.16"
                  color="#95a5a6"></a-plane>
          <a-text value="Fechar" position="0 -0.38 0.02" align="center" width="2" color="#111"></a-text>
        </a-entity>

      <!-- Exterior -->
      <a-plane position="0 -0.1 -50" rotation="-90 0 0" width="150" height="300" color="#333" shadow="receive: true"></a-plane>
      <a-plane position="-20 0 -50" rotation="-90 0 0" width="2" height="200" color="#fff"></a-plane>
      <a-plane position="-35 0 -50" rotation="-90 0 0" width="1" height="200" color="#fff"></a-plane>
      <a-box position="0 -0.05 34" width="20" height="0.1" depth="8" color="#7f8c8d"></a-box>

      <!-- =========================
           TERMINAL (MAIOR)
           ========================= -->

      <!-- ChÃ£o maior (antes: height=40). Agora estende atÃ© aos gates -->
      <a-plane position="0 0 -10" rotation="-90 0 0"
               width="18" height="80"
               src="#chao-tex" repeat="5 18" roughness="0.4"
               shadow="receive: true"></a-plane>

      <!-- Teto maior -->
      <a-box position="0 7 -10" width="20" depth="84" height="0.5" color="#fff" shadow="cast: true"></a-box>

      <!-- Paredes laterais (mais compridas) -->
      <a-box position="-9 3.5 -10" width="0.5" height="7" depth="80"
             color="#aaddff" material="opacity: 0.5; transparent: true"></a-box>
      <a-box position="9 3.5 -10" width="0.5" height="7" depth="80"
             src="#parede-tex" repeat="16 2" shadow="cast: true; receive: true"></a-box>

      <!-- Parede do fundo (mais para trÃ¡s) -->
      <a-box position="0 3.5 -50" width="18" height="7" depth="0.2"
             color="#aaddff" material="opacity: 0.3; transparent: true"></a-box>

      <!-- Portas entrada -->
      <!-- FACHADA / ENTRADA EM VIDRO (com "porta" ao meio) -->
      <!-- Painel esquerdo -->
      <a-box position="-5.5 3.5 29.906" width="7" height="7" depth="0.2"
            color="#aaddff" material="opacity: 0.5; transparent: true"></a-box>

      <!-- Painel direito -->
      <a-box position="5.5 3.5 29.906" width="7" height="7" depth="0.2"
            color="#aaddff" material="opacity: 0.5; transparent: true"></a-box>

      <!-- Pilar esquerdo da porta -->
      <a-box position="-1.2 3.5 29.906" width="0.25" height="7" depth="0.4" color="#333"></a-box>

      <!-- Pilar direito da porta -->
      <a-box position="1.2 3.5 29.906" width="0.25" height="7" depth="0.4" color="#333"></a-box>

      <!-- Travessa superior da porta (opcional, dÃ¡ mais "cara" de entrada) -->
      <a-box position="0 6.95 29.906" width="2.4" height="0.15" depth="0.4" color="#333"></a-box>

      <a-box position="0 5 29.941" width="6" height="0.2" depth="4" color="#333"></a-box>
      <a-text value="ENTRADA" position="-0.222 4.515 31.266" rotation="0 0 0" align="center" color="#fff" width="10"></a-text>

      <!-- Luzes ao longo do terminal -->
      <a-entity light="type: point; intensity: 0.55; distance: 18" position="0 6 12"></a-entity>
      <a-entity light="type: point; intensity: 0.55; distance: 18" position="0 6 0"></a-entity>
      <a-entity light="type: point; intensity: 0.55; distance: 18" position="0 6 -12"></a-entity>
      <a-entity light="type: point; intensity: 0.55; distance: 18" position="0 6 -24"></a-entity>
      <a-entity light="type: point; intensity: 0.55; distance: 18" position="0 6 -36"></a-entity>

      <!-- =========================
           CHECK-IN
           ========================= -->
      <a-entity position="3.7 3.579 20.208" rotation="0 270 0" scale="1 1 1">
        <a-box width="4" height="0.6" depth="0.1" color="#1b4f72"></a-box>
        <a-text value="CHECK-IN" align="center" position="0 0 0.06" width="6" color="#fff"></a-text>
      </a-entity>

      <a-entity id="checkinDesk" class="clickable"
      gltf-model="#modelo-balcao" position="5.597 0 17.196"
      scale="0.9 0.9 0.9" rotation="0 180 0" shadow="cast: true"></a-entity>

      <a-box id="checkinDeskHit"
       class="clickable"
       position="5.597 1.1 17.196"
       rotation="0 180 0"
       width="3.2" height="2.2" depth="2.0"
       material="opacity: 0; transparent: true"
       shadow="cast: false; receive: false"></a-box>

       <!-- Dropzone para despachar a mala (porÃ£o) -->
      <a-cylinder id="baggageDropzone"
        class ="clickable"
        position="3.516 0.392 17.701"
        rotation="90 90 0"
        scale="0.5 0.5 0.5"
        radius="0.7" height="0.06"
        color="#8e44ad"
        material="opacity:0.85; transparent:true"></a-cylinder>

      <a-text value="BAG DROP" position="3.6 0.981 17.721"  rotation="0 270 0"
        align="center" width="4" color="#e9d7ff"></a-text>



      <a-entity gltf-model="#modelo-balcao" position="5.597 0 23.292"  scale="0.9 0.9 0.9" rotation="0 180 0" shadow="cast: true"></a-entity>

      <!-- MALA (aparece no check-in; click = pegar/largar) -->
      <a-entity id="luggage" class="clickable"
                position="3 0 20.866" rotation="0 90 0" visible="true">
        <a-entity class="clickable"
                  gltf-model="#modelo-mala"
                  scale="1.5 1.5 1.5"
                  rotation="0 0 0">
        </a-entity>
      </a-entity>

      <!-- MOCHILA (item pessoal para quando escolhe PORÃƒO) -->
      <a-entity id="backpack" class="clickable"
                position="3.35 0 20.866" rotation="0 90 0" visible="false">
        <a-entity class="clickable"
                  gltf-model="#modelo-backpack"
                  scale="1.5 1.5 1.5"
                  rotation="0 0 0">
        </a-entity>
      </a-entity>

      <!-- TELEMÃ“VEL (comeÃ§a invisÃ­vel e no inventÃ¡rio, mas existe no mundo para feedback no scanner) -->
      <a-entity id="phone" class="clickable"
                position="3.7 0.258 20.866" rotation="50 90 0" visible="false">
        <a-entity class="clickable"
                  gltf-model="#modelo-iphone"
                  position="0 0.300 0"
                  scale="2 2 2"
                  rotation="0 0 0">
        </a-entity>
      </a-entity>


      <!-- =========================
     CADEIRAS NA ZONA DO CHECK-IN
     (4 cadeiras, depois ajustas rotaÃ§Ã£o/posiÃ§Ã£o)
     ========================= -->
      <a-entity id="checkinChairs" position="2.5 0 22" rotation="0 90 0">
        <a-entity gltf-model="#modelo-cadeira" position="1.832 0 -9.5"   rotation="0 0 0" scale="1 1 1"></a-entity>
        <a-entity gltf-model="#modelo-cadeira" position="1.832 0 -7.5" rotation="0 0 0" scale="1 1 1"></a-entity>
        <a-entity gltf-model="#modelo-cadeira" position="4.832 0 -9.5"  rotation="0 0 0" scale="1 1 1"></a-entity>
        <a-entity gltf-model="#modelo-cadeira" position="4.832 0 -7.5" rotation="0 0 0" scale="1 1 1"></a-entity>
        <a-entity gltf-model="#modelo-cadeira" position="-1.168 0 -9.5" rotation="0 0 0" scale="1 1 1"></a-entity>
        <a-entity gltf-model="#modelo-cadeira" position="-1.168 0 -7.5" rotation="0 0 0" scale="1 1 1"></a-entity>
      </a-entity>

      <!-- =========================
           SECURITY (mantida)
           ========================= -->
        <a-entity position="0 0 1"> <a-box id="securityWall" 
               position="0 2.5 0" 
               width="5.5" height="5" depth="0.1" 
               color="red" 
               material="opacity: 0.3; transparent: true; side: double"
               visible="true">
        </a-box>
        
        <a-text id="securityWallText" value="PARE!\nApresente o cartÃ£o de embarque\ne passe no scanner."
                align="center" position="0 3.621 0.1" width="6" color="red"></a-text>

        <a-box position="0 4.618 1.078" width="4" height="0.6" depth="0.1" color="#196f3d"></a-box>
        <a-text value="SECURITY CHECK" align="center" position="0 4.638 1.179" width="6" color="#fff"></a-text>

        <a-entity gltf-model="#modelo-security" position="-2.712 0 0" scale="0.9 0.9 0.9" rotation="0 90 0"></a-entity>
        <a-entity gltf-model="#modelo-security" position="2.712 0 0" scale="0.9 0.9 0.9" rotation="0 270 0"></a-entity>

        <a-entity
          id="scannerSfxEntity"
          position="2.771 1.2 1.625"
          sound="src: #scannerSfx; volume: 0.9; poolSize: 5; positional: true; refDistance: 2; distanceModel: inverse"
        ></a-entity>




        <!-- DROPZONE DO SCANNER (onde tens de largar a mala) -->
        <a-cylinder id="securityDropzone"
                    class ="clickable"
                    position="2.771 0.937 1.625"
                    radius="0.8" height="0.05"
                    color="#27ae60"
                    material="opacity: 0.80; transparent: true"
                    shadow="receive: true">
        </a-cylinder>

        <a-text value="SCANNER" position="2.780 1.270 1.744"
                align="center" width="4" color="#b7f5d1"></a-text>
      </a-entity>

      <!-- Leitor do cartÃ£o de embarque (mostrar BP) -->
      <a-box id="bpReader"
        position="4.066 1.3 1.843"
        width="0.5" height="0.6" depth="0.2"
        color="#2ecc71"
        class="clickable"></a-box>
      <a-text value="SCAN BP" position="4.086 1.765 1.2"
        align="center" width="4" color="#c8ffe0"></a-text>


      <!-- =========================
           CORREDOR PARA GATES + SINAL
           ========================= -->
      <a-entity id="gateSign" position="0 3.5 -21.241">
        <a-box width="6" height="0.8" depth="0.12" color="#111"></a-box>
        <a-text id="gateSignText" value="GATES AREA" align="center" position="0 0 0.08" width="8" color="#fff"></a-text>
      </a-entity>

      <!-- =========================
           WAITING AREA (CADEIRAS)
           ========================= -->

      <!-- Tapete/Ã¡rea de espera -->
      <a-plane position="0 0.01 -28" rotation="-90 0 0" width="16" height="14"
               color="#2c3e50" material="opacity: 0.35; transparent: true"></a-plane>

      <!-- Cadeiras em grelha (3 colunas x 4 filas) -->
      <a-entity id="waitingArea" position="0 0 -26">
        <!-- fila 1 -->
        <a-entity gltf-model="#modelo-cadeira" position="-4 0 0"  rotation="0 180 0" scale="1 1 1"></a-entity>
        <a-entity gltf-model="#modelo-cadeira" position="0 0 0"   rotation="0 180 0" scale="1 1 1"></a-entity>
        <a-entity gltf-model="#modelo-cadeira" position="4 0 0"   rotation="0 180 0" scale="1 1 1"></a-entity>

        <!-- fila 2 -->
        <a-entity gltf-model="#modelo-cadeira" position="-4 0 -3" rotation="0 180 0" scale="1 1 1"></a-entity>
        <a-entity gltf-model="#modelo-cadeira" position="0 0 -3"  rotation="0 180 0" scale="1 1 1"></a-entity>
        <a-entity gltf-model="#modelo-cadeira" position="4 0 -3"  rotation="0 180 0" scale="1 1 1"></a-entity>

        <!-- fila 3 -->
        <a-entity gltf-model="#modelo-cadeira" position="-4 0 -6" rotation="0 180 0" scale="1 1 1"></a-entity>
        <a-entity gltf-model="#modelo-cadeira" position="0 0 -6"  rotation="0 180 0" scale="1 1 1"></a-entity>
        <a-entity gltf-model="#modelo-cadeira" position="4 0 -6"  rotation="0 180 0" scale="1 1 1"></a-entity>

        <!-- fila 4 -->
        <a-entity gltf-model="#modelo-cadeira" position="-4 0 -9" rotation="0 180 0" scale="1 1 1"></a-entity>
        <a-entity gltf-model="#modelo-cadeira" position="0 0 -9"  rotation="0 180 0" scale="1 1 1"></a-entity>
        <a-entity gltf-model="#modelo-cadeira" position="4 0 -9"  rotation="0 180 0" scale="1 1 1"></a-entity>
      </a-entity>

      <!-- =========================
           GATES (mais para trÃ¡s + placas 3D)
           ========================= -->


      <a-entity position="-4 1.5 -38" rotation="0 45 0">
        <a-text value="PREVIEW: PARIS" align="center" position="0 1.3 0" color="#333" scale="1.5 1.5 1.5"></a-text>
        <a-text value="(Clica para ver o destino)" align="center" position="0 1.1 0" color="#555" scale="0.8 0.8 0.8"></a-text>

        <a-sphere class="clickable" 
                  destination-preview
                  radius="0.6" 
                  color="#3498db" 
                  material="opacity: 0.9; roughness: 0.2; metalness: 0.8"
                  animation="property: position; dir: alternate; dur: 2000; easing: easeInOutSine; loop: true; to: 0 0.1 0">
        </a-sphere>
        
        <a-cylinder radius="0.1" height="1" position="0 -1 0" color="#888"></a-cylinder>
      </a-entity>

      <!-- Gate A1 -->
      <a-entity id="gateA1" position="-6 1 -44">
        <a-box width="2.4" height="2.2" depth="0.12" color="#d8b88f"></a-box>
        <a-text value="GATE A1" position="0 1.35 0.14" align="center" color="#111"></a-text>

        <!-- placa 3D do gate -->
        <a-entity gltf-model="#modelo-gate-sign" position="0 2.8 0.6" rotation="0 0 0" scale="0.25 0.25 0.25"></a-entity>
        <a-text value="A1" position="0 3.35 0.7" align="center" color="#fff" width="6"></a-text>
      </a-entity>

      <!-- Gate A2 -->
      <a-entity id="gateA2" position="0 1 -44">
        <a-box width="2.4" height="2.2" depth="0.12" color="#d8b88f"></a-box>
        <a-text value="GATE A2" position="0 1.35 0.14" align="center" color="#111"></a-text>

        <a-entity gltf-model="#modelo-gate-sign" position="0 2.8 0.6" rotation="0 0 0" scale="0.25 0.25 0.25"></a-entity>
        <a-text value="A2" position="0 3.35 0.7" align="center" color="#fff" width="6"></a-text>
      </a-entity>

      <!-- Gate A3 -->
      <a-entity id="gateA3" position="6 1 -44">
        <a-box width="2.4" height="2.2" depth="0.12" color="#d8b88f"></a-box>
        <a-text value="GATE A3" position="0 1.35 0.14" align="center" color="#111"></a-text>

        <a-entity gltf-model="#modelo-gate-sign" position="0 2.8 0.6" rotation="0 0 0" scale="0.25 0.25 0.25"></a-entity>
        <a-text value="A3" position="0 3.35 0.7" align="center" color="#fff" width="6"></a-text>
      </a-entity>

    </a-scene>
  </body>
</html>
