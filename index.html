<!doctype html>
<html lang="pt">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aeroporto VR ‚Äî Wayfinding</title>

    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

<script>
AFRAME.registerComponent("face-camera", {
  tick: function () {
    const cam = document.getElementById("cam");
    if (!cam) return;
    const camPos = cam.object3D.getWorldPosition(new THREE.Vector3());
    this.el.object3D.lookAt(camPos);
    this.el.object3D.rotation.x = 0;
    this.el.object3D.rotation.z = 0;
  },
});

AFRAME.registerComponent("wayfinding", {
  init: function () {
    this.state = {
      checkinMode: null,                 // "online" | "airport"
      started: false,
      gateArrived: false,


      handWeight: 0,
      hasCheckedBag: false,              // se existe mala de por√£o
      checkedIn: false,                  // se j√° foi despachada (bag drop)
      luggageWeight: 0,
      
      checkedItems: [],               // "luggage" | "backpack"

      boardingPassIssued: false,
      passengerIdentified: false,        // airport: depois de inserir dados

      security: {
        boardingPassShown: false,
        scannedBackpack: false,
        scannedPhone: false,
        scannedLuggage: false,
      },

      items: {
        backpack: true,
        phone: true,
        luggage: false,
      },


      securityPassed: false,
      gate: null,
      destination: null,
    };

    // UI tempor√°ria do painel inicial 3D
    this.ui = {
      mode: null,
      hasBackpack: true,
      hasPhone: true,
      hasLuggage: false,
      handWeight: 6,
      luggageWeight: 0,
      onlineChecked: false,

      desk: {            // ‚úÖ ADICIONA ISTO
        code: "",
        bagChoice: "hand",
      },
    };



    this.el.sceneEl.addEventListener("loaded", () => {
      this.hudTarget = document.getElementById("hudTarget");
      this.successSound = document.getElementById("soundSuccess");
      this.wall = document.getElementById("securityWall");
      this.wallText = document.getElementById("securityWallText");
      this.barrier = document.getElementById("securityBarrier");


      this.checkinDeskHit = document.getElementById("checkinDeskHit");
      this.bagDropzone = document.getElementById("baggageDropzone");
      this.securityDropzone = document.getElementById("securityDropzone");
      this.bpReader = document.getElementById("bpReader");

      this.sky = document.getElementById("main-sky");

      // guardar estado original do sky (para voltar atr√°s)
      this._skyDefault = {
        color: this.sky?.getAttribute("color"),
        src: this.sky?.getAttribute("src"),
      };

      this._previewOn = false;

      // refs dos textos do preview
      this.previewTitle = document.getElementById("previewTitle");
      this.previewHint = document.getElementById("previewHint");

      // tenta j√° atualizar (mesmo que ainda n√£o haja destino)
      this.updateDestinationPreviewUI?.();


      this.checkinDeskHit?.addEventListener("click", () => this.onDeskClick());

      // Abrir painel de seguran√ßa clicando no c√≠rculo verde OU no leitor
      this.securityDropzone?.addEventListener("click", () => this.openSecurityPanel());
      this.bpReader?.addEventListener("click", () => this.openBPPanel());



      // Bag Drop abre ‚Äúdespachar‚Äù
      this.bagDropzone?.addEventListener("click", () => this.onBagDropClick());

      this.setObjective("‚úàÔ∏è Configure the workflow in the panel and click Start.", null);
      this.updateBPUI();

      // ‚úÖ painel inicial 3D (bind + refresh)
      this.bindFlowPanelButtons();
      this.refreshFlowPanel();
      this.updateCheckinHint?.();


    });
  },


  updateCheckinHint: function () {
  const isAirport = this.ui?.mode === "airport";
  const notCheckedIn = !this.state.checkedIn;

  const show = isAirport && notCheckedIn;

  document.getElementById("checkinHint")?.setAttribute("visible", show);
  document.getElementById("checkinHintBg")?.setAttribute("visible", show);
},


  playScannerSfx: function () {
    const sfx = document.getElementById("scannerSfxEntity");
    sfx?.components?.sound?.stopSound?.(); // garante replay imediato
    sfx?.components?.sound?.playSound?.();
  },


  getPanoForDestination: function () {
  const dest = (this.state.destination || "").toLowerCase();

  if (dest.includes("paris")) return "#panoParis";
  if (dest.includes("madrid")) return "#panoMadrid";
  if (dest.includes("londres") || dest.includes("london")) return "#panoLondon";

  return null;
},

updateDestinationPreviewUI: function () {
  const dest = this.state.destination || "‚Äî";
  if (this.previewTitle) this.previewTitle.setAttribute("value", `PREVIEW: ${dest}`);
},

toggleDestinationPreview: function () {
  if (!this.sky) this.sky = document.getElementById("main-sky");
  if (!this.sky) return;

  const pano = this.getPanoForDestination?.();

  // se ainda n√£o tens destino / pano, avisa no HUD
  if (!pano) {
    this.setObjective?.("‚ÑπÔ∏è Ainda n√£o h√° destino definido para preview.", null);
    return;
  }

  this._previewOn = !this._previewOn;

  if (this._previewOn) {
    // ligar panorama
    this.sky.setAttribute("src", pano);
    // opcional: se quiseres esconder cor quando h√° src, n√£o √© preciso
    this.setObjective?.(`üåç Preview do destino: ${this.state.destination}`, null);

    if (this.previewHint) this.previewHint.setAttribute("value", "(Clica novamente para voltar)");
  } else {
    // voltar ao c√©u original
    if (this._skyDefault?.src) this.sky.setAttribute("src", this._skyDefault.src);
    else this.sky.removeAttribute("src");

    if (this._skyDefault?.color) this.sky.setAttribute("color", this._skyDefault.color);
    else this.sky.setAttribute("color", "#87CEEB");

    this.setObjective?.("‚úÖ Voltaste ao aeroporto.", null);
    if (this.previewHint) this.previewHint.setAttribute("value", "(Clica para ver o destino)");
  }
},

tick: function () {
  // ----------------------------
  // BLOQUEIO PARA OS GATES (antes da seguran√ßa)
  // ----------------------------
  if (!this.state.securityPassed) {
    const cam = document.getElementById("cam");
    if (!cam) return;

    // onde est√° a parede (world Z)
    const wall = document.getElementById("securityWall");
    const wallWorld = wall
      ? wall.object3D.getWorldPosition(new THREE.Vector3())
      : new THREE.Vector3(0, 0, 0);

    // limite: um bocadinho "antes" da parede (do lado permitido)
    // ajusta o +0.25 se precisares (0.15 a 0.40 √© normal)
    const limitZ = wallWorld.z + 0.25;

    // posi√ß√£o atual da cam em world
    const camWorld = cam.object3D.getWorldPosition(new THREE.Vector3());

    // se a cam est√° a tentar passar para o lado proibido (z menor que a parede),
    // empurra s√≥ o Z de volta para o limite
    if (camWorld.z < limitZ) {
      const targetWorld = new THREE.Vector3(camWorld.x, camWorld.y, limitZ);

      // converter world -> local (para mexer na position correta mesmo com parents)
      const parent = cam.object3D.parent;
      if (parent) {
        parent.worldToLocal(targetWorld);
        cam.object3D.position.z = targetWorld.z; // s√≥ ajusta Z
      } else {
        cam.object3D.position.z += (limitZ - camWorld.z); // fallback
      }
    }

    return; // antes da seguran√ßa n√£o checamos gate
  }

  // ----------------------------
  // CHEGADA AO GATE (depois da seguran√ßa)
  // ----------------------------
  if (!this.state.gate || this.state.gateArrived) return;

  const cam = document.getElementById("cam");
  const gateId =
    this.state.gate === "A1" ? "gateA1" :
    this.state.gate === "A2" ? "gateA2" : "gateA3";

  const gateEl = document.getElementById(gateId);
  if (!cam || !gateEl) return;

  const targetBoxId = this.getGateBoxId(this.state.gate);
  if (targetBoxId) {
    const cur = document.getElementById(targetBoxId)?.getAttribute("color");
    if (cur === "#d8b88f") this.setGateColor(this.state.gate, "#3498db");
  }

  const p = cam.object3D.getWorldPosition(new THREE.Vector3());
  const g = gateEl.object3D.getWorldPosition(new THREE.Vector3());
  const dist = p.distanceTo(g);

  if (dist < 2.5) {
    this.state.gateArrived = true;
    this.markGateAsArrived();

    this.setObjective?.(
      `üéâ You arrived at Gate ${this.state.gate}! Have a good trip to ${this.state.destination}!`,
      null
    );

    this.successSound?.components?.sound?.playSound?.();
  }
},








  // -------- UI Objective + BP ----------
  setObjective: function (text, targetId = null) {
    if (this.hudTarget) this.hudTarget.textContent = text;

    document.querySelectorAll("[data-highlighted='1']").forEach(el => {
      el.removeAttribute("animation__pulse");
      el.setAttribute("data-highlighted", "0");
    });

    if (!targetId) return;
    const el = document.getElementById(targetId);
    if (!el) return;

    el.setAttribute("data-highlighted", "1");
    el.setAttribute(
      "animation__pulse",
      "property: scale; dir: alternate; dur: 700; easing: easeInOutSine; loop: true; to: 1.05 1.05 1.05"
    );
  },

  issueBoardingPass: function () {
    const pool = [
      { gate: "A1", dest: "Paris" },
      { gate: "A2", dest: "Londres" },
      { gate: "A3", dest: "Madrid" },
    ];
    const pick = pool[Math.floor(Math.random() * pool.length)];

    this.state.gate = pick.gate;
    this.state.destination = pick.dest;
    this.state.boardingPassIssued = true;

    const bp = document.getElementById("boardingPass");
    if (bp) bp.style.display = "block";

    this.updateBPUI();
    this.successSound?.components?.sound?.playSound?.();
    this.updateDestinationPreviewUI?.();

  },

updateBPUI: function () {
  const l1 = document.getElementById("bpLine1");
  const l2 = document.getElementById("bpLine2");

  const gate = this.state.gate ?? "‚Äî";
  const dest = this.state.destination ?? "‚Äî";
  if (l1) l1.textContent = `Gate: ${gate} | Destination: ${dest}`;

  const bpOk = this.state.boardingPassIssued ? "‚úÖ" : "‚õî";
  const idOk = this.state.checkinMode === "airport"
    ? (this.state.passengerIdentified ? "‚úÖ" : "‚õî")
    : "‚Äî";

  // por√£o: se h√° itens para por√£o, tens de os despachar
  const checkedItems = Array.isArray(this.state.checkedItems) ? this.state.checkedItems : [];
  const porao = checkedItems.length > 0 ? (this.state.checkedIn ? "‚úÖ" : "‚õî") : "‚Äî";

  const bpShown = this.state.security?.boardingPassShown ? "‚úÖ" : "‚õî";

  // ‚úÖ ler invent√°rio real
  const carry = this.getCarrySys?.();
  const inv = carry?.inventory || { backpack: false, phone: false, luggage: false };

  // ‚úÖ existe no jogo (selecionado no modal inicial)
  const existsBackpack = !!this.state.items?.backpack;
  const existsPhone = !!this.state.items?.phone;
  const existsLuggage = !!this.state.items?.luggage;

  // ‚úÖ ainda est√° contigo (no invent√°rio)
  const carryBackpack = !!inv.backpack;
  const carryPhone = !!inv.phone;
  const carryLuggage = !!inv.luggage;

  // ‚úÖ mala s√≥ √© ‚Äúcabine‚Äù se N√ÉO estiver nos itens de por√£o
  const luggageInHold = checkedItems.includes("luggage");
  const needLuggage = existsLuggage && carryLuggage && !luggageInHold;

  // ‚úÖ s√≥ √© necess√°rio scanar se existe E est√° contigo
  const needBackpack = existsBackpack && carryBackpack;
  const needPhone = existsPhone && carryPhone;

  const scanOk =
    (!needBackpack || !!this.state.security?.scannedBackpack) &&
    (!needPhone || !!this.state.security?.scannedPhone) &&
    (!needLuggage || !!this.state.security?.scannedLuggage);

  const secOk = this.state.securityPassed ? "‚úÖ" : "‚õî";

  if (l2) l2.textContent =
    `BP: ${bpOk} ‚Ä¢ Identification: ${idOk} ‚Ä¢ Cargo Hold: ${porao} ‚Ä¢ BP shown: ${bpShown} ‚Ä¢ Scanner: ${scanOk ? "‚úÖ" : "‚õî"} ‚Ä¢ Security: ${secOk}`;
},


bindFlowPanelButtons: function () {
  if (this._flowBound) return;
  this._flowBound = true;

  const $ = (id) => document.getElementById(id);

  // modo
  $("uiModeOnline")?.addEventListener("click", () => {
    this.ui.mode = "online";
    this.refreshFlowPanel();
    this.updateCheckinHint?.();
  });
  $("uiModeAirport")?.addEventListener("click", () => {
    this.ui.mode = "airport";
    this.refreshFlowPanel();
    this.updateCheckinHint?.();
  });

  // toggles pertences
  $("uiHasBackpack")?.addEventListener("click", () => {
    this.ui.hasBackpack = !this.ui.hasBackpack;
    this.refreshFlowPanel();
  });
  $("uiHasPhone")?.addEventListener("click", () => {
    this.ui.hasPhone = !this.ui.hasPhone;
    this.refreshFlowPanel();
  });
  $("uiHasLuggage")?.addEventListener("click", () => {
    this.ui.hasLuggage = !this.ui.hasLuggage;
    // se tirou mala, n√£o faz sentido despachar mala
    if (!this.ui.hasLuggage) this.ui.onlineChecked = false;
    this.refreshFlowPanel();
  });

  // pesos (+/-) (passos de 1kg, ajusta se quiseres 0.5)
  $("uiHandMinus")?.addEventListener("click", () => {
    this.ui.handWeight = Math.max(0, (this.ui.handWeight || 0) - 1);
    this.refreshFlowPanel();
  });
  $("uiHandPlus")?.addEventListener("click", () => {
    this.ui.handWeight = (this.ui.handWeight || 0) + 1;
    this.refreshFlowPanel();
  });

  $("uiLuggMinus")?.addEventListener("click", () => {
    this.ui.luggageWeight = Math.max(0, (this.ui.luggageWeight || 0) - 1);
    this.refreshFlowPanel();
  });
  $("uiLuggPlus")?.addEventListener("click", () => {
    this.ui.luggageWeight = (this.ui.luggageWeight || 0) + 1;
    this.refreshFlowPanel();
  });

  // online checked
  $("uiOnlineChecked")?.addEventListener("click", () => {
    if (this.ui.mode !== "online") return;
    if (!this.ui.hasLuggage) return; // s√≥ faz sentido se tiver mala
    this.ui.onlineChecked = !this.ui.onlineChecked;
    this.refreshFlowPanel();
  });

  // come√ßar
  $("uiFlowStart")?.addEventListener("click", () => this.startFlowFromPanel());
},

refreshFlowPanel: function () {
  const $ = (id) => document.getElementById(id);

  // textos SIM/N√ÉO
  $("uiHasBackpackTxt")?.setAttribute(
    "value",
    `üéí Backpack: ${this.ui.hasBackpack ? "YES" : "NO"}`
  );
  $("uiHasPhoneTxt")?.setAttribute(
    "value",
    `üì± Phone: ${this.ui.hasPhone ? "YES" : "NO"}`
  );
  $("uiHasLuggageTxt")?.setAttribute(
    "value",
    `üß≥ Luggage: ${this.ui.hasLuggage ? "YES" : "NO"}`
  );

  $("uiHandWLabel")?.setAttribute(
    "value",
    `Backpack weight: ${(this.ui.handWeight || 0).toFixed(1)}kg`
  );
  $("uiLuggWLabel")?.setAttribute(
    "value",
    `Luggage weight: ${(this.ui.luggageWeight || 0).toFixed(1)}kg`
  );

  // online checked vis√≠vel s√≥ no modo online
  const onlineRow = $("uiOnlineChecked");
  if (onlineRow) onlineRow.setAttribute("visible", this.ui.mode === "online");

  $("uiOnlineCheckedTxt")?.setAttribute(
    "value",
    `(Online) Dispatch baggage: ${this.ui.onlineChecked ? "YES" : "NO"}`
  );

  // warn
  let warn = "";
  if (!this.ui.mode) warn = "‚ö†Ô∏è Choose mode (Online or Airport).";
  $("uiFlowWarn")?.setAttribute("value", warn);

  // ----------------------------
  // CORES / ESTADO (feedback visual)
  // ----------------------------
  const ACTIVE = "#3498db";     // selecionado (azul)
  const INACTIVE = "#ffffff";   // neutro
  const ON = "#2ecc71";         // toggle ligado (verde)
  const OFF = "#ffffff";        // toggle desligado (cinza)

  // helper inline (n√£o dependes de teres setActivePair definido)
  const set = (id, color) => this.setBtnColor?.(id, color);

  // modo (online/airport)
  if (this.ui.mode === "online") {
    set("uiModeOnline", ACTIVE);
    set("uiModeAirport", INACTIVE);
  } else if (this.ui.mode === "airport") {
    set("uiModeOnline", INACTIVE);
    set("uiModeAirport", ACTIVE);
  } else {
    set("uiModeOnline", INACTIVE);
    set("uiModeAirport", INACTIVE);
  }

  // toggles pertences (Backpack/Phone/Luggage)
  set("uiHasBackpack", this.ui.hasBackpack ? ON : OFF);
  set("uiHasPhone", this.ui.hasPhone ? ON : OFF);
  set("uiHasLuggage", this.ui.hasLuggage ? ON : OFF);

  // online checked (s√≥ quando faz sentido)
  const canOnlineCheck = (this.ui.mode === "online") && !!this.ui.hasLuggage;
  if (canOnlineCheck) {
    set("uiOnlineChecked", this.ui.onlineChecked ? ON : OFF);
  } else {
    // se est√° escondido ou n√£o aplic√°vel, mete neutro
    set("uiOnlineChecked", INACTIVE);
  }
},


setBtnColor: function (id, color) {
  const el = document.getElementById(id);
  if (!el) return;
  el.setAttribute("color", color);
},

setActivePair: function (idA, idB, activeId, activeColor, inactiveColor) {
  this.setBtnColor(idA, idA === activeId ? activeColor : inactiveColor);
  this.setBtnColor(idB, idB === activeId ? activeColor : inactiveColor);
},



startFlowFromPanel: function () {
  if (!this.ui.mode) {
    document.getElementById("uiFlowWarn")?.setAttribute("value", "‚ö†Ô∏è Escolhe o modo primeiro.");
    return;
  }

  // aplica ao state real
  this.state.checkinMode = this.ui.mode;
  this.state.started = true;

  this.state.items = {
    backpack: !!this.ui.hasBackpack,
    phone: !!this.ui.hasPhone,
    luggage: !!this.ui.hasLuggage,
  };

  this.state.handWeight = this.state.items.backpack ? (this.ui.handWeight || 0) : 0;
  this.state.luggageWeight = this.state.items.luggage ? (this.ui.luggageWeight || 0) : 0;

  // reset do fluxo
  this.state.checkedItems = [];
  this.state.checkedIn = false;
  this.state.security.boardingPassShown = false;
  this.state.security.scannedBackpack = false;
  this.state.security.scannedPhone = false;
  this.state.security.scannedLuggage = false;

  // regras (igual ao que tinhas, agora no painel)
  const forcedByLuggage = this.state.items.luggage && this.state.luggageWeight > 20;
  const forcedByBackpack = this.state.items.backpack && this.state.handWeight > 10;
  const wantsChecked = !!this.ui.onlineChecked;

  if (this.state.checkinMode === "online") {
    if (forcedByLuggage) this.state.checkedItems.push("luggage");
    if (forcedByBackpack) this.state.checkedItems.push("backpack");
    if (!forcedByLuggage && this.state.items.luggage && wantsChecked) {
      if (!this.state.checkedItems.includes("luggage")) this.state.checkedItems.push("luggage");
    }
  } else {
    // airport: decis√£o no balc√£o (mant√©ns o deskModal ou fazes deskPanel depois)
    this.state.checkedItems = [];
  }

  this.state.hasCheckedBag = this.state.checkedItems.length > 0;

  // esconder painel inicial
  document.getElementById("uiFlowPanel")?.setAttribute("visible", "false");

  // invent√°rio
  const carry = this.getCarrySys();
  carry?.syncFromFlowState?.(this.state);

  // continua o teu fluxo normal
  if (this.state.checkinMode === "online") {
    if (!this.state.boardingPassIssued) this.issueBoardingPass();

    if (this.state.checkedItems.length > 0) {
      this.setObjective("üß≥ Go to Bag Drop to dispatch your bags. (purple circle)", "baggageDropzone");
    } else {
      this.setObjective("üîê Go to security (green circle) and complete the scanner.", "securityDropzone");
    }
  } else {
    this.setObjective("üè¢ Go to the check-in desk and enter your details.", "checkinDeskHit");
  }

  this.updateBPUI();
},

openBagDropPanel: function () {
  const panel = document.getElementById("uiBagDropPanel");
  if (!panel) return;

  panel.setAttribute("visible", "true");
  this.bindBagDropPanelButtons();
  this.refreshBagDropPanel();
},

bindBagDropPanelButtons: function () {
  if (this._bagBound) return;
  this._bagBound = true;

  const btnClose = document.getElementById("uiBagDropClose");
  const btnL = document.getElementById("uiDropLuggage");
  const btnB = document.getElementById("uiDropBackpack");

  btnClose?.addEventListener("click", () => {
    document.getElementById("uiBagDropPanel")?.setAttribute("visible", "false");
  });

  btnL?.addEventListener("click", () => this.dropSpecificToHold("luggage"));
  btnB?.addEventListener("click", () => this.dropSpecificToHold("backpack"));
},

refreshBagDropPanel: function () {
  const checked = Array.isArray(this.state.checkedItems) ? this.state.checkedItems : [];
  const carry = this.getCarrySys();

  const t = document.getElementById("uiBagDropStatus");
  const btnL = document.getElementById("uiDropLuggage");
  const btnB = document.getElementById("uiDropBackpack");

  const hasL = checked.includes("luggage");
  const hasB = checked.includes("backpack");

  // mostrar/esconder bot√µes conforme necess√°rio
  document.getElementById("uiDropLuggage")?.setAttribute("visible", hasL);
  document.getElementById("uiDropLuggageTxt")?.setAttribute("visible", hasL);

  document.getElementById("uiDropBackpack")?.setAttribute("visible", hasB);
  document.getElementById("uiDropBackpackTxt")?.setAttribute("visible", hasB);

  // status leg√≠vel
  const falta = [];
  if (hasL) falta.push("luggage");
  if (hasB) falta.push("backpack");

  if (t) t.setAttribute("value", falta.length ? `Missing to dispatch: ${falta.join(" + ")}` : "Nothing to dispatch.");

  // cores √∫teis (se o item j√° n√£o est√° no invent√°rio, ‚Äúdisabled‚Äù)
  const ACTIVE = "#8e44ad";
  const DISABLED = "#7f8c8d";

  if (hasL) btnL?.setAttribute("color", carry?.inventory?.luggage ? ACTIVE : DISABLED);
  if (hasB) btnB?.setAttribute("color", carry?.inventory?.backpack ? ACTIVE : DISABLED);

  if (hasL && !carry?.inventory?.luggage) this.setObjective("You don't have the luggage in the inventory (I).", null);
  if (hasB && !carry?.inventory?.backpack) this.setObjective("You don't have the backpack in the inventory (I).", null);
},


dropSpecificToHold: function (item) {
  this.state.checkedItems = this.state.checkedItems || [];
  const carry = this.getCarrySys();

  if (!this.state.checkedItems.includes(item)) {
    this.refreshBagDropPanel();
    return;
  }

  // tem de estar no invent√°rio
  if (!carry?.inventory?.[item]) {
    const name = item === "luggage" ? "luggage" : "backpack";
    this.setObjective(`‚ö†Ô∏è You don't have the ${name} in the inventory. Open the inventory (I).`, null);
    carry?.openInventoryUI?.();
    return;
  }

  // remove definitivamente
  carry?.removeForever?.(item);

  // remove da lista
  this.state.checkedItems = this.state.checkedItems.filter(x => x !== item);

  this.successSound?.components?.sound?.playSound?.();

  // se acabou tudo:
  if (this.state.checkedItems.length === 0) {
    this.state.checkedIn = true;
    this.state.hasCheckedBag = false;

    document.getElementById("uiBagDropPanel")?.setAttribute("visible", "false");
    this.setObjective("‚úÖ Everything dispatched. Now go to security.", "securityDropzone");
  } else {
    this.state.checkedIn = false;
    this.state.hasCheckedBag = true;
    this.setObjective("‚úÖ Item dispatched. Still need to dispatch the rest.", "baggageDropzone");
    this.refreshBagDropPanel();
  }

  this.updateBPUI();
},


  // -------- Balc√£o (airport): inserir dados + decidir por√£o (com regra) ----------
  onDeskClick: function () {
    if (!this.state.started) return;

  if (this.state.checkinMode === "airport") {
    this.openDeskPanel();
    return;
  }


    // online: balc√£o pode s√≥ orientar (opcional)
    if (this.state.checkinMode === "online") {
      if (this.state.hasCheckedBag && !this.state.checkedIn) {
        this.setObjective("üß≥ Go to BAG DROP to dispatch the luggage.", "baggageDropzone");
      } else {
        this.setObjective("üîê Go to security and complete the scanner.", "securityDropzone");
      }
    }
  },


  // -------- Bag Drop: painel simples via click (roxo) ----------
onBagDropClick: function () {
  if (!this.state.started) return;

  this.state.checkedItems = this.state.checkedItems || [];

  if (this.state.checkedItems.length === 0) {
    this.setObjective("‚ÑπÔ∏è You have nothing to dispatch in the hold. Proceed to security.", "securityDropzone");
    return;
  }

  this.openBagDropPanel(); // ‚úÖ opens 3D panel
},


tryPassSecurity: function () {
  if (this.state.securityPassed) return;

  if (!this.state.boardingPassIssued) return;
  if (this.state.hasCheckedBag && !this.state.checkedIn) return;
  if (!this.state.security.boardingPassShown) return;

  const carry = this.getCarrySys();

  const carryBackpack = !!carry?.inventory?.backpack;
  const carryPhone = !!carry?.inventory?.phone;
  const carryLuggage = !!carry?.inventory?.luggage;

  const existsBackpack = !!this.state.items.backpack;
  const existsPhone = !!this.state.items.phone;
  const existsLuggage = !!this.state.items.luggage;

  const needBackpack = existsBackpack && carryBackpack;
  const needPhone = existsPhone && carryPhone;
  const checkedItems = Array.isArray(this.state.checkedItems) ? this.state.checkedItems : [];
  const luggageInHold = checkedItems.includes("luggage");
  const needLuggage = existsLuggage && carryLuggage && !luggageInHold;


  const all =
    (!needBackpack || this.state.security.scannedBackpack) &&
    (!needPhone || this.state.security.scannedPhone) &&
    (!needLuggage || this.state.security.scannedLuggage);

  if (!all) return;

  this.passSecurity(300);
},


  passSecurity: function (delayMs = 0) {
    if (this.state.securityPassed) return;

    const doPass = () => {
      this.state.securityPassed = true;

      if (this.wall) this.wall.setAttribute("visible", "false");
      if (this.wallText) this.wallText.setAttribute("value", "");

      const gateId = this.state.gate === "A1" ? "gateA1" : this.state.gate === "A2" ? "gateA2" : "gateA3";
      this.setObjective(`‚úÖ Security completed! Proceed to Gate ${this.state.gate}.`, gateId);

      this.state.gateArrived = false;
      this.highlightTargetGate();

      this.successSound?.components?.sound?.playSound?.();
      this.updateBPUI();

    };

    if (delayMs) setTimeout(doPass, delayMs);
    else doPass();
  },

  getCarrySys: function () {
    return this.el.sceneEl.components["carry-system"];
  },

  getGateBoxId: function (gate) {
    if (!gate) return null;
    return gate === "A1" ? "gateA1Box" : gate === "A2" ? "gateA2Box" : "gateA3Box";
  },

  resetAllGates: function () {
    const base = "#d8b88f"; // original color of your a-box
    ["gateA1Box", "gateA2Box", "gateA3Box"].forEach((id) => {
      document.getElementById(id)?.setAttribute("color", base);
    });
  },

  setGateColor: function (gate, color) {
    const id = this.getGateBoxId(gate);
    if (!id) return;
    document.getElementById(id)?.setAttribute("color", color);
  },

  highlightTargetGate: function () {
    this.resetAllGates();
    this.setGateColor(this.state.gate, "#3498db"); // azul destino
  },

  markGateAsArrived: function () {
    // opcional: manter os outros base e o destino verde
    this.resetAllGates();
    this.setGateColor(this.state.gate, "#2ecc71"); // verde chegou
  },




openSecurityPanel: function () {
  if (!this.state.started) return;

  const panel = document.getElementById("uiSecurityPanel");
  const bpPanel = document.getElementById("uiBPPanel");
  if (bpPanel) bpPanel.setAttribute("visible", "false");
  if (!panel) return;

  panel.setAttribute("visible", "true");
  this.bindSecurityPanelButtons();
  this.refreshSecurityPanel();
},

openBPPanel: function () {
  if (!this.state.started) return;

  const panel = document.getElementById("uiBPPanel");
  const secPanel = document.getElementById("uiSecurityPanel");
  if (secPanel) secPanel.setAttribute("visible", "false");
  if (!panel) return;

  panel.setAttribute("visible", "true");
  this.bindBPPanelButtons();
  this.refreshBPPanel();
},

openDeskPanel: function () {
  if (!this.state.started) return;
  if (this.state.checkinMode !== "airport") return;

  const panel = document.getElementById("uiDeskPanel");
  if (!panel) return;

  panel.setAttribute("visible", "true");
  this.bindDeskPanelButtons();
  this.refreshDeskPanel();
},

bindDeskPanelButtons: function () {
  if (this._deskBound) return;
  this._deskBound = true;

  const btnEnter = document.getElementById("uiDeskEnter");
  const btnHand = document.getElementById("uiDeskHand");
  const btnChecked = document.getElementById("uiDeskChecked");
  const btnConfirm = document.getElementById("uiDeskConfirm");
  const btnClose = document.getElementById("uiDeskClose");

  btnClose?.addEventListener("click", () => {
    document.getElementById("uiDeskPanel")?.setAttribute("visible", "false");
  });

  // inserir dados (aqui continua a usar prompt, mas j√° dentro do painel 3D)
  btnEnter?.addEventListener("click", () => {
    const code = prompt("Enter data: reservation code / document / flight number:");
    if (!code || code.trim().length < 4) {
      this.ui.desk.code = "";
      this.refreshDeskPanel("‚ö†Ô∏è Invalid data (min 4 chars).");
      return;
    }
    this.ui.desk.code = code.trim();
    this.refreshDeskPanel("");
  });

  btnHand?.addEventListener("click", () => {
    this.ui.desk.bagChoice = "hand";
    this.refreshDeskPanel("");
  });

  btnChecked?.addEventListener("click", () => {
    this.ui.desk.bagChoice = "checked";
    this.refreshDeskPanel("");
  });

  btnConfirm?.addEventListener("click", () => this.confirmDeskPanel());
},

refreshDeskPanel: function (forceWarn = "") {
  const codeTxt = document.getElementById("uiDeskCode");
  const warnTxt = document.getElementById("uiDeskWarn");
  const handTxt = document.getElementById("uiDeskHandTxt");
  const checkedTxt = document.getElementById("uiDeskCheckedTxt");

  const btnHand = document.getElementById("uiDeskHand");
  const btnChecked = document.getElementById("uiDeskChecked");

  if (codeTxt) {
    codeTxt.setAttribute("value", `Code: ${this.ui.desk.code ? this.ui.desk.code : "(empty)"}`);
  }

  // regra: se mochila > 10kg for√ßa por√£o
  const forcedBackpack = this.state.items?.backpack && (this.state.handWeight || 0) > 10;
  const forcedWarn = forcedBackpack ? "‚ö†Ô∏è Backpack > 10kg: hold mandatory." : "";

  const warn = forceWarn || forcedWarn || "";
  if (warnTxt) warnTxt.setAttribute("value", warn);

  // se for√ßado, sobrep√µe escolha
  if (forcedBackpack) this.ui.desk.bagChoice = "checked";

  const isHand = this.ui.desk.bagChoice === "hand";
  const isChecked = this.ui.desk.bagChoice === "checked";

  // labels
  if (handTxt) handTxt.setAttribute("value", isHand ? "‚úÖ Hand" : "Hand");
  if (checkedTxt) checkedTxt.setAttribute("value", isChecked ? "‚úÖ Cargo Hold" : "üß≥ Cargo Hold");

  // cores (feedback visual)
  const ACTIVE = "#3498db";
  const INACTIVE = "#2c3e50";

  btnHand?.setAttribute("color", isHand ? ACTIVE : INACTIVE);
  btnChecked?.setAttribute("color", isChecked ? ACTIVE : INACTIVE);
},

confirmDeskPanel: function () {
  // valida dados
  if (!this.ui.desk.code || this.ui.desk.code.trim().length < 4) {
    this.refreshDeskPanel("‚ö†Ô∏è You must enter the data first.");
    return;
  }

  // marca identificado
  this.state.passengerIdentified = true;
  if (!this.state.boardingPassIssued) this.issueBoardingPass();

  // reset
  this.state.checkedItems = [];
  this.state.checkedIn = false;

  const wantsChecked = (this.ui.desk.bagChoice === "checked");

  // 1) se escolheu por√£o e tem mala -> mala por√£o
  if (wantsChecked && this.state.items?.luggage) {
    this.state.checkedItems.push("luggage");
  }

  // 2) regra mochila > 10kg -> mochila por√£o
  if (this.state.items?.backpack && (this.state.handWeight || 0) > 10) {
    if (!this.state.checkedItems.includes("backpack")) this.state.checkedItems.push("backpack");
  }

  // 3) regra mala ‚Äúcabine‚Äù limite 10kg (igual ao que tinhas)
  if (this.state.items?.luggage && !wantsChecked && (this.state.luggageWeight || 0) > 10) {
    this.refreshDeskPanel("‚ö†Ô∏è Luggage > 10kg cannot go in cabin. Choose Cargo Hold.");
    this.ui.desk.bagChoice = "checked";
    return;
  }

  this.state.hasCheckedBag = this.state.checkedItems.length > 0;

  // fecha painel
  document.getElementById("uiDeskPanel")?.setAttribute("visible", "false");

  // objetivos
  this.updateBPUI();

  if (this.state.checkedItems.length > 0) {
    const falta = this.state.checkedItems.map(x => (x === "luggage" ? "luggage" : "backpack")).join(" + ");
    this.setObjective(`üß≥ Go to BAG DROP (purple circle) and dispatch: ${falta}.`, "baggageDropzone");
  } else {
    this.setObjective("üîê Go to security (green circle) and complete the scanner.", "securityDropzone");
  }

  this.updateCheckinHint?.();

},


bindSecurityPanelButtons: function () {
  if (this._secBound) return;
  this._secBound = true;

  const carry = this.getCarrySys();

  const btnBack = document.getElementById("uiBtnAddBackpack");
  const btnPhone = document.getElementById("uiBtnAddPhone");
  const btnLuggage = document.getElementById("uiBtnAddLuggage");
  const btnClose = document.getElementById("uiBtnCloseSec");

  btnClose?.addEventListener("click", () => {
    document.getElementById("uiSecurityPanel")?.setAttribute("visible", "false");
  });

  btnBack?.addEventListener("click", () => {
    // regra peso
    if ((this.state.handWeight || 0) > 10) {
      this.setObjective("‚õî Backpack > 10kg. Open inventory (I) and remove.", null);
      carry?.openInventoryUI?.();
      return;
    }
    if (!carry?.inventory?.backpack) return;
    this.state.security.scannedBackpack = true;
    carry?.showBackpackOnScanner?.();
    this.playScannerSfx?.();
    this.updateBPUI();
    this.tryPassSecurity();
    this.refreshSecurityPanel();
  });

  btnPhone?.addEventListener("click", () => {
    if (!carry?.inventory?.phone) return;
    this.state.security.scannedPhone = true;
    carry?.showPhoneOnScanner?.();
    this.playScannerSfx?.();
    this.updateBPUI();
    this.tryPassSecurity();
    this.refreshSecurityPanel();
  });

  btnLuggage?.addEventListener("click", () => {
    // s√≥ se for cabine
    const checkedItems = Array.isArray(this.state.checkedItems) ? this.state.checkedItems : [];
    const luggageInHold = checkedItems.includes("luggage");
    if (luggageInHold) return;

    if (!carry?.inventory?.luggage) return;
    this.state.security.scannedLuggage = true;
    carry?.showLuggageOnScanner?.();
    this.playScannerSfx?.();
    this.updateBPUI();
    this.tryPassSecurity();
    this.refreshSecurityPanel();
  });
},

refreshSecurityPanel: function () {
  const t = document.getElementById("uiSecStatus");
  if (!t) return;

  const carry = this.getCarrySys();
  const checkedItems = Array.isArray(this.state.checkedItems) ? this.state.checkedItems : [];
  const luggageInHold = checkedItems.includes("luggage");

  // helpers
  const mk = (kind) => (kind === "ok" ? "OK" : kind === "no" ? "FALTA" : "NA");

  // por√£o
  const porao =
    (checkedItems.length > 0)
      ? (this.state.checkedIn ? mk("ok") : mk("no"))
      : mk("na");

  // ‚Äúprecisa‚Äù s√≥ se existe e est√° contigo
  const needBackpack = !!(this.state.items.backpack && carry?.inventory?.backpack);
  const needPhone    = !!(this.state.items.phone && carry?.inventory?.phone);
  const needLuggage   = !!(this.state.items.luggage && carry?.inventory?.luggage && !luggageInHold);

  const b = needBackpack ? (this.state.security.scannedBackpack ? mk("ok") : mk("no")) : mk("na");
  const p = needPhone    ? (this.state.security.scannedPhone    ? mk("ok") : mk("no")) : mk("na");
  const l = needLuggage  ? (this.state.security.scannedLuggage  ? mk("ok") : mk("no")) : mk("na");

  // missing list
  const missing = [];
  if (checkedItems.length > 0 && !this.state.checkedIn) missing.push("Cargo Hold");
  if (needBackpack && !this.state.security.scannedBackpack) missing.push("Backpack");
  if (needPhone && !this.state.security.scannedPhone) missing.push("Phone");
  if (needLuggage && !this.state.security.scannedLuggage) missing.push("Luggage (cabin)");

  const missingLine = missing.length ? `Missing: ${missing.join(", ")}` : "All OK";

  t.setAttribute(
    "value",
    `Cargo Hold: ${porao}\nBackpack: ${b} | Phone: ${p}\nLuggage (cabin): ${l}\n${missingLine}`
  );

  // ---------- CORES DOS BOT√ïES ----------
  const OK = "#2ecc71";
  const WAIT = "#f39c12";
  const NA = "#2c3e50";
  const DISABLED = "#7f8c8d";

  const btnBack = document.getElementById("uiBtnAddBackpack");
  const btnPhone = document.getElementById("uiBtnAddPhone");
  const btnLuggage = document.getElementById("uiBtnAddLuggage");

  if (!this.state.items.backpack) btnBack?.setAttribute("color", NA);
  else if (!carry?.inventory?.backpack) btnBack?.setAttribute("color", DISABLED);
  else btnBack?.setAttribute("color", this.state.security.scannedBackpack ? OK : WAIT);

  if (!this.state.items.phone) btnPhone?.setAttribute("color", NA);
  else if (!carry?.inventory?.phone) btnPhone?.setAttribute("color", DISABLED);
  else btnPhone?.setAttribute("color", this.state.security.scannedPhone ? OK : WAIT);

  if (!this.state.items.luggage) btnLuggage?.setAttribute("color", NA);
  else if (luggageInHold) btnLuggage?.setAttribute("color", NA);
  else if (!carry?.inventory?.luggage) btnLuggage?.setAttribute("color", DISABLED);
  else btnLuggage?.setAttribute("color", this.state.security.scannedLuggage ? OK : WAIT);
},



bindBPPanelButtons: function () {
  if (this._bpBound) return;
  this._bpBound = true;

  const btnShow = document.getElementById("uiBtnShowBP");
  const btnClose = document.getElementById("uiBtnCloseBP");

  btnClose?.addEventListener("click", () => {
    document.getElementById("uiBPPanel")?.setAttribute("visible", "false");
  });

  btnShow?.addEventListener("click", () => {
    if (!this.state.boardingPassIssued) {
      this.setObjective("üé´ Ainda n√£o tens BP. Faz check-in primeiro.", "checkinDeskHit");
      return;
    }

    const checkedItems = Array.isArray(this.state.checkedItems) ? this.state.checkedItems : [];
    if (checkedItems.length > 0 && !this.state.checkedIn) {
      this.setObjective("üß≥ Antes: despacha no BAG DROP.", "baggageDropzone");
      return;
    }

    this.state.security.boardingPassShown = true;
    this.successSound?.components?.sound?.playSound?.();
    this.updateBPUI();
    this.refreshBPPanel();
  });
},

refreshBPPanel: function () {
  const t = document.getElementById("uiBPStatus");
  const btn = document.getElementById("uiBtnShowBP");
  if (!t || !btn) return;

  const shown = !!this.state.security.boardingPassShown;

  // texto claro (sem emojis)
  t.setAttribute("value", `BP: ${shown ? "OK" : "MISSING"}`);

  // cor do bot√£o
  btn.setAttribute("color", shown ? "#2ecc71" : "#f39c12");
},



});

AFRAME.registerComponent("carry-system", {
  init: function () {
    console.log("[carry-system] INIT");

    this.inventory = { backpack: false, phone: false, luggage: false };
    this.exists = { backpack: false, phone: false, luggage: false };

    this.spawn = {
      backpack: { x: 3.35, y: 0, z: 20.866 },
      luggage:  { x: 3.0,  y: 0, z: 20.866 },
      phone:    { x: 3.7,  y: 0, z: 20.866 },
    };

    this._ready = false;
    this._inv3DBound = false;
    this._keyBound = false;
    this._setupTries = 0;

    const scene = this.el.sceneEl;
    if (scene.hasLoaded) this.trySetup();
    else scene.addEventListener("loaded", () => this.trySetup());
  },

  trySetup: function () {
    this._setupTries++;

    this.backpack = document.getElementById("backpack");
    this.luggage  = document.getElementById("luggage");
    this.phone    = document.getElementById("phone");

    this.securityDropzone = document.getElementById("securityDropzone");
    this.player = document.getElementById("player");
    this.cam    = document.getElementById("cam");

    // UI Invent√°rio 3D (no A-SCENE, N√ÉO parented √† c√¢mara)
    this.invPanel = document.getElementById("uiInvPanel");
    this.invHint  = document.getElementById("uiInvHint");

    this.invBtnBackpack = document.getElementById("uiInvBackpack");
    this.invBtnPhone    = document.getElementById("uiInvPhone");
    this.invBtnLuggage  = document.getElementById("uiInvLuggage");

    this.invTxtBackpack = document.getElementById("uiInvBackpackTxt");
    this.invTxtPhone    = document.getElementById("uiInvPhoneTxt");
    this.invTxtLuggage  = document.getElementById("uiInvLuggageTxt");

    if (!this.cam || !this.invPanel) {
      if (this._setupTries < 160) return setTimeout(() => this.trySetup(), 50);
      console.error("[carry-system] setup failed: cam or uiInvPanel not found");
      return;
    }

    if (this._ready) return;
    this._ready = true;

    // estado inicial do painel
    this.invPanel.setAttribute("visible", "false");
    this.invPanel.setAttribute("rotation", "0 0 0");
    this.invPanel.setAttribute("scale", "1 1 1");

    // itens no mundo clic√°veis
    this.backpack?.classList.add("clickable");
    this.luggage?.classList.add("clickable");
    this.phone?.classList.add("clickable");

    this.backpack?.addEventListener("click", () => this.pickUp("backpack"));
    this.luggage?.addEventListener("click", () => this.pickUp("luggage"));
    this.phone?.addEventListener("click", () => this.pickUp("phone"));

    this.bindInventoryPanelButtons();

    // Tecla I (uma vez). Ignora auto-repeat.
    if (!this._keyBound) {
      this._keyBound = true;
      window.addEventListener("keydown", (e) => {
        if (e.repeat) return;
        if (e.key === "i" || e.key === "I") {
          console.log("[carry-system] KeyI pressed");
          this.toggleInventoryUI();
        }
      });
    }

    this.hideWorldItems();
    this.refreshInventoryPanel();
  },

  // chamado no flowStart
  syncFromFlowState: function (wfState) {
    const items = wfState?.items || { backpack: false, phone: false, luggage: false };

    this.exists.backpack = !!items.backpack;
    this.exists.phone    = !!items.phone;
    this.exists.luggage  = !!items.luggage;

    this.inventory.backpack = this.exists.backpack;
    this.inventory.phone    = this.exists.phone;
    this.inventory.luggage  = this.exists.luggage;

    this.hideWorldItems();
    this.refreshInventoryPanel();
  },

  hideWorldItems: function () {
    this.backpack?.setAttribute("visible", "false");
    this.luggage?.setAttribute("visible", "false");
    this.phone?.setAttribute("visible", "false");
  },

  // ---------- INVENT√ÅRIO UI (cr√≠tico)
  toggleInventoryUI: function () {
    if (!this.invPanel) return;
    const v = this.invPanel.getAttribute("visible");
    const open = (v === true || v === "true");
    if (open) this.closeInventoryUI();
    else this.openInventoryUI();
  },

  openInventoryUI: function () {
    if (!this.invPanel || !this.cam) return;

    this.refreshInventoryPanel();

    // ‚úÖ Coloca o painel NO MUNDO, uma vez, perto do jogador (n√£o fica colado √† c√¢mara)
    const camObj = this.cam.object3D;

    const camPos = camObj.getWorldPosition(new THREE.Vector3());
    const q = camObj.quaternion;

    const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(q);
    const right   = new THREE.Vector3(1, 0, 0).applyQuaternion(q);

    // √† frente e um bocado ao lado (tipo "ao teu lado", como quando dropas items)
    const pos = camPos.clone()
      .add(forward.multiplyScalar(1.15))
      .add(right.multiplyScalar(0.38));

    pos.y -= 0.25;

    this.invPanel.setAttribute("position", `${pos.x} ${pos.y} ${pos.z}`);

    // olha para a c√¢mara, mas N√ÉO reposiciona a cada frame
    this.invPanel.object3D.lookAt(camPos);
    this.invPanel.object3D.rotation.x = 0;
    this.invPanel.object3D.rotation.z = 0;

    this.invPanel.setAttribute("visible", "true");
  },

  closeInventoryUI: function () {
    if (!this.invPanel) return;
    this.invPanel.setAttribute("visible", "false");
  },

  // ---------- DROP / PICKUP
  drop: function (id) {
    if (!this.exists[id]) return;
    this.inventory[id] = false;

    const wf = this.el.sceneEl.components.wayfinding;
    if (wf?.state?.security) {
      if (id === "backpack") wf.state.security.scannedBackpack = false;
      if (id === "phone")    wf.state.security.scannedPhone = false;
      if (id === "luggage")  wf.state.security.scannedLuggage = false;
      wf.updateBPUI?.();
    }

    const el = this[id];
    if (!el) return this.refreshInventoryPanel();

    const camEl = this.cam || document.getElementById("cam");
    if (camEl) {
      const p = camEl.object3D.getWorldPosition(new THREE.Vector3());
      const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(camEl.object3D.quaternion);

      const dx = p.x + forward.x * 0.9;
      const dz = p.z + forward.z * 0.9;

      el.setAttribute("position", `${dx} 0 ${dz}`);
      el.setAttribute("visible", "true");
    } else {
      const s = this.spawn[id];
      if (s) el.setAttribute("position", `${s.x} ${s.y} ${s.z}`);
      el.setAttribute("visible", "true");
    }

    this.refreshInventoryPanel();
  },

  pickUp: function (id) {
    if (!this.exists[id]) return;
    this.inventory[id] = true;
    this[id]?.setAttribute("visible", "false");
    this.refreshInventoryPanel();
  },

  removeForever: function (id) {
    this.inventory[id] = false;
    this.exists[id] = false;
    this[id]?.setAttribute("visible", "false");
    this.refreshInventoryPanel();
  },

  // ---------- SEGURAN√áA
  showBackpackOnScanner: function () {
    if (!this.backpack || !this.securityDropzone) return;
    if (!this.inventory.backpack) return;
    const dz = this.securityDropzone.getAttribute("position");
    this.backpack.setAttribute("position", `${dz.x - 0.25} ${dz.y - 0.1} ${dz.z - 2.5}`);
    this.backpack.setAttribute("rotation", "0 180 0");
    this.backpack.setAttribute("visible", "true");
  },

  showLuggageOnScanner: function () {
    if (!this.luggage || !this.securityDropzone) return;
    if (!this.inventory.luggage) return;
    const dz = this.securityDropzone.getAttribute("position");
    this.luggage.setAttribute("position", `${dz.x + 0.35} ${dz.y - 0.1} ${dz.z - 2.5}`);
    this.luggage.setAttribute("rotation", "0 180 0");
    this.luggage.setAttribute("visible", "true");
  },

  showPhoneOnScanner: function () {
    if (!this.phone || !this.securityDropzone) return;
    if (!this.inventory.phone) return;
    const dz = this.securityDropzone.getAttribute("position");
    this.phone.setAttribute("position", `${dz.x} ${dz.y - 0.1} ${dz.z - 1.6}`);
    this.phone.setAttribute("rotation", "0 180 0");
    this.phone.setAttribute("visible", "true");
  },

  snapBackpackToScanner: function () { this.showBackpackOnScanner(); },
  snapPhoneToScanner: function () { this.showPhoneOnScanner(); },

  // ---------- BOT√ïES DO PAINEL
  bindInventoryPanelButtons: function () {
    if (this._inv3DBound) return;
    this._inv3DBound = true;

    const handle = (id) => {
      if (!this.exists[id]) return;
      if (this.inventory[id]) this.drop(id);
      else this.pickUp(id);
    };

    this.invBtnBackpack?.addEventListener("click", () => handle("backpack"));
    this.invBtnPhone?.addEventListener("click", () => handle("phone"));
    this.invBtnLuggage?.addEventListener("click", () => handle("luggage"));
  },

refreshInventoryPanel: function () {
  if (!this.invPanel) return;

  const ON = "#2ecc71";      // est√° no invent√°rio
  const OFF = "#e74c3c";     // est√° fora
  const NEUTRAL = "#2c3e50"; // fallback

  const line = (id, label) => {
    if (!this.exists[id]) return `${label}: (n√£o existe)`;
    return this.inventory[id]
      ? `${label}: ‚úÖ no invent√°rio (clicar para remover)`
      : `${label}: ‚õî fora (clicar para adicionar)`;
  };

  // textos
  this.invTxtBackpack?.setAttribute("value", line("backpack", "üéí Backpack"));
  this.invTxtPhone?.setAttribute("value", line("phone", "üì± Phone"));
  this.invTxtLuggage?.setAttribute("value", line("luggage", "üß≥ Luggage"));

  // mostrar/esconder
  const eb = !!this.exists.backpack;
  const ep = !!this.exists.phone;
  const el = !!this.exists.luggage;

  this.invBtnBackpack?.setAttribute("visible", eb);
  this.invTxtBackpack?.setAttribute("visible", eb);

  this.invBtnPhone?.setAttribute("visible", ep);
  this.invTxtPhone?.setAttribute("visible", ep);

  this.invBtnLuggage?.setAttribute("visible", el);
  this.invTxtLuggage?.setAttribute("visible", el);

  // cores (feedback visual)
  if (eb) this.invBtnBackpack?.setAttribute("color", this.inventory.backpack ? ON : OFF);
  else this.invBtnBackpack?.setAttribute("color", NEUTRAL);

  if (ep) this.invBtnPhone?.setAttribute("color", this.inventory.phone ? ON : OFF);
  else this.invBtnPhone?.setAttribute("color", NEUTRAL);

  if (el) this.invBtnLuggage?.setAttribute("color", this.inventory.luggage ? ON : OFF);
  else this.invBtnLuggage?.setAttribute("color", NEUTRAL);
},

});


AFRAME.registerComponent("destination-preview", {
  init: function () {
    this.el.addEventListener("click", () => {
      const wf = this.el.sceneEl.components["wayfinding"];
      wf?.toggleDestinationPreview?.();
    });
  },
});

window.addEventListener("DOMContentLoaded", () => {
  const app = document.getElementById("app");

  const toggleFs = async () => {
    if (!document.fullscreenElement) {
      await app?.requestFullscreen?.();
    } else {
      await document.exitFullscreen?.();
    }
  };

  window.addEventListener("keydown", (e) => {
    if (e.key.toLowerCase() === "f") toggleFs();
  });
});

</script>


    <style>
      html, body { margin: 0; height: 100%; overflow: hidden; }
      #hud {
        position: fixed; left: 12px; top: 12px; z-index: 10;
        background: rgba(0,0,0,.6); color: #fff; padding: 10px 12px;
        border-radius: 12px; font-family: system-ui, sans-serif; font-size: 14px;
      }

      #btnOnline{ background:#2ecc71; }
      #btnCounter{ background:#f1c40f; }

      .bp{
        position:fixed; right:12px; top:12px; z-index:11;
        width:320px; background:rgba(0,0,0,.65); color:#fff;
        padding:12px; border-radius:12px; font-family:system-ui,sans-serif;
        border:1px solid rgba(255,255,255,.12);
      }
      .bp-title{ font-weight:700; margin-bottom:6px; }
      .bp-line{ font-size:13px; opacity:.95; margin-top:4px; }

      @media (max-width: 520px){
        .bp{ width: calc(100% - 24px); left: 12px; right: 12px; top: auto; bottom: 12px; }
        #hud{ right: 12px; }
      }

      #app{
        position: fixed;
        inset: 0;
        width: 100vw;
        height: 100vh;
      }



    </style>
  </head>

<body>
  <div id="app">
    <div id="hud">
      <b>VR Airport</b><br />WASD ‚Ä¢ Mouse ‚Ä¢ Click<br/><br/>
      <br/><span id="hudTarget">Enter the airport and check in.</span>
    </div>

    <div id="boardingPass" class="bp" style="display:none;">
      <div class="bp-title">üé´ Boarding Pass</div>
      <div id="bpLine1" class="bp-line">Gate: ‚Äî | Destination: ‚Äî</div>
      <div id="bpLine2" class="bp-line">
        BP: ‚õî ‚Ä¢ Luggage: ‚õî ‚Ä¢ Tag: ‚Äî ‚Ä¢ Drop-off: ‚Äî ‚Ä¢ Security: ‚õî
      </div>
    </div>

    <a-scene id="scene"
      wayfinding carry-system audio-unlock
      vr-mode-ui="enabled: false"
      renderer="colorManagement: true; physicallyCorrectLights: true;"
      shadow="type: pcfsoft">

      <a-sky id="main-sky" color="#87CEEB"></a-sky>



      
      <a-assets>
        <img id="chao-tex" src="assets/images/chao2.jpg">
        <img id="parede-tex" src="assets/images/parede.jpg">
        <img id="asfalto-tex" src="https://cdn.aframe.io/a-painter/images/floor.jpg">

        <img id="panoParis"  src="assets/images/paris.jpg">
        <img id="panoMadrid" src="assets/images/Madrid.jpg">
        <img id="panoLondon" src="assets/images/londres.jpg">

        <a-asset-item id="aviaoModel" src="assets/models/avi√£o.glb"></a-asset-item>
        <a-asset-item id="modelo-mala" src="assets/models/luggage.glb"></a-asset-item>
        <a-asset-item id="modelo-backpack" src="assets/models/backpack.glb"></a-asset-item>
        <a-asset-item id="modelo-balcao" src="assets/models/airport_check_in_desk.glb"></a-asset-item>
        <a-asset-item id="modelo-security" src="assets/models/airport_security_check.glb"></a-asset-item>
        <a-asset-item id="modelo-iphone" src="assets/models/iphone.glb"></a-asset-item>
        <a-asset-item id="modelo-cadeira" src="assets/models/waiting_chair.glb"></a-asset-item>
        <a-asset-item id="modelo-gate-sign" src="assets/models/airport_boarding_gate_sign.glb"></a-asset-item>
        <a-asset-item id="vmachineModel" src="assets/models/vmachine.glb"></a-asset-item>
        <a-asset-item id="vmachineModel2" src="assets/models/vmachine2.glb"></a-asset-item>


        <audio id="airportAmbience"
       src="https://cdn.pixabay.com/download/audio/2022/03/24/audio_3079b47e40.mp3"
       preload="auto"
       crossorigin="anonymous"></audio>

        <audio id="successClip"
              src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_0625c153e1.mp3"
              preload="auto"
              crossorigin="anonymous"></audio>

        <audio id="scannerSfx" src="assets/audio/scannerSound.wav" preload="auto"></audio>

      </a-assets>

      

      <a-entity id="ambience" sound="src: #airportAmbience; autoplay: true; loop: true; volume: 0.5"></a-entity>

      <a-entity id="soundSuccess" sound="src: #successClip; volume: 1.0; poolSize: 5"></a-entity>

      <a-entity light="type: directional; castShadow: true; intensity: 1.5; shadowCameraVisible: false;"
                position="-20 50 -20" target="#directionaltarget">
        <a-entity id="directionaltarget" position="0 0 0"></a-entity>
      </a-entity>
      <a-entity light="type: ambient; intensity: 0.6; color: #fff"></a-entity>

      <a-entity id="player" position="0 0 25">
        <a-camera id="cam" position="0 1.6 0"
                  wasd-controls="acceleration: 50"
                  look-controls="pointerLockEnabled: true; mouseSensitivity: 0.06">
          <a-cursor raycaster="objects: .clickable" fuse="false" material="color: white; shader: flat"></a-cursor>
        </a-camera>
      </a-entity>

      <a-entity
        id="vendingMachine2"
        gltf-model="#vmachineModel2"
        position="8.269 1 -10"
        rotation="0 90 0"
        scale="1 1 1">
      </a-entity>

            <a-entity
        id="vendingMachine"
        gltf-model="#vmachineModel"
        position="10.245 1.173 -12"
        rotation="0 270 0"
        scale="1 1 1">
      </a-entity>

      <a-entity
        id="vendingMachine2"
        gltf-model="#vmachineModel2"
        position="8.269 1 -16"
        rotation="0 90 0"
        scale="1 1 1">
      </a-entity>

            <a-entity
        id="vendingMachine"
        gltf-model="#vmachineModel"
        position="10.245 1.173 -6"
        rotation="0 270 0"
        scale="1 1 1">
      </a-entity>

      <a-entity
        id="vendingMachine"
        gltf-model="#vmachineModel"
        position="10.245 1.173 14"
        rotation="0 270 0"
        scale="1 1 1">
      </a-entity>

            <a-entity
        id="vendingMachine"
        gltf-model="#vmachineModel"
        position="10.245 1.173 12"
        rotation="0 270 0"
        scale="1 1 1">
      </a-entity>

            <a-entity
        id="vendingMachine"
        gltf-model="#vmachineModel"
        position="10.245 1.173 10"
        rotation="0 270 0"
        scale="1 1 1">
      </a-entity>


      <a-entity
        id="aviaoExterior"
        gltf-model="#aviaoModel"
        position="-27.147 3.406 -36.535"
        rotation="-10 180 0"
        scale="5 5 5">
      </a-entity>

            <a-entity
        id="aviaoExterior"
        gltf-model="#aviaoModel"
        position="-13.418 0 20.669"
        rotation="0 120 0"
        scale="4 4 4">
      </a-entity>

            <a-entity
        id="aviaoExterior"
        gltf-model="#aviaoModel"
        position="-13.854 0 4.457"
        rotation="0 120 0"
        scale="4 4 4">
      </a-entity>



      <a-entity id="uiInvPanel"
    visible="false"
    rotation="0 0 0"
    face-camera>

  <!-- FUNDO -->
  <a-plane width="2.55" height="1.55" color="#111"
          radius="0.06"
          material="opacity:0.90; transparent:true; shader: flat"></a-plane>

  <a-text value="üéí Inventory"
          position="0 0.62 0.01"
          align="center" width="2.4" wrap-count="20" color="#fff"></a-text>

  <a-text id="uiInvHint"
          value="I to close"
          position="0 0.429 0.01"
          align="center" width="2.2" wrap-count="22" color="#bdbdbd"></a-text>

  <!-- Mochila -->
  <a-plane id="uiInvBackpack" class="clickable"
          position="0 0.18 0.01" width="2.10" height="0.22"
          color="#2c3e50"></a-plane>
  <a-text id="uiInvBackpackTxt"
          value="üéí Backpack: ‚Äî"
          position="0 0.18 0.02" align="center" width="2.10" wrap-count="40" color="#fff"></a-text>

  <!-- Telem√≥vel -->
  <a-plane id="uiInvPhone" class="clickable"
          position="0 -0.10 0.01" width="2.10" height="0.22"
          color="#2c3e50"></a-plane>
  <a-text id="uiInvPhoneTxt"
          value="üì± Phone: ‚Äî"
          position="0 -0.10 0.02" align="center" width="2.10" wrap-count="40" color="#fff"></a-text>

  <!-- Mala -->
  <a-plane id="uiInvLuggage" class="clickable"
          position="0 -0.38 0.01" width="2.10" height="0.22"
          color="#2c3e50"></a-plane>
  <a-text id="uiInvLuggageTxt"
          value="üß≥ Luggage: ‚Äî"
          position="0 -0.38 0.02" align="center" width="2.10" wrap-count="40" color="#fff"></a-text>

</a-entity>



<a-entity id="uiFlowPanel"
          position="0 1.7 23"
          rotation="0 180 0"
          visible="true"
          face-camera>

  <!-- FUNDO (maior + cantos arredondados) -->
  <a-plane width="2.95" height="2.05" color="#111"
           radius="0.06"
           material="opacity:0.90; transparent:true; shader:flat"></a-plane>

  <!-- T√çTULO -->
  <a-text value="CHECK-IN"
          position="0 0.90 0.01"
          align="center" width="2.75"
          wrap-count="20"
          color="#fff"></a-text>

  <!-- MODO -->
  <a-text value="Mode"
          position="-1.249 0.713 0.011"
          align="left" width="2.65"
          color="#d0d0d0"></a-text>

  <a-plane id="uiModeOnline" class="clickable"
          position="-0.704 0.50 0.011" width="1.05" height="0.22"
          color="#2ecc71"></a-plane>
  <a-text value="‚úÖ Online"
          position="-0.721 0.50 0.022"
          align="center" width="1.8"
          color="#111"></a-text>

  <a-plane id="uiModeAirport" class="clickable"
          position="0.740 0.50 0.008" width="1.05" height="0.22"
          color="#f1c40f"></a-plane>
  <a-text value="üè¢ Airport"
          position="0.753 0.50 0.018"
          align="center" width="1.8"
          color="#111"></a-text>

  <!-- BELONGINGS -->
  <a-text value="Belongings"
          position="-1.244 0.23 0.001"
          align="left" width="2.65"
          color="#d0d0d0"></a-text>

  <a-plane id="uiHasBackpack" class="clickable"
          position="-0.844 0.03 0.01" width="0.78" height="0.18"
          color="#34495e"></a-plane>
  <a-text id="uiHasBackpackTxt" value="üéí Backpack: YES"
          position="-0.889 0.03 0.02" align="center"
          width="1.7" wrap-count="22"
          color="#fff"></a-text>

  <a-plane id="uiHasPhone" class="clickable"
          position="0.044 0.03 0.01" width="0.78" height="0.18"
          color="#34495e"></a-plane>
  <a-text id="uiHasPhoneTxt" value="üì± Phone: YES"
          position="0.034 0.03 0.02" align="center"
          width="1.7" wrap-count="22"
          color="#fff"></a-text>

  <a-plane id="uiHasLuggage" class="clickable"
          position="0.973 0.03 0.009" width="0.78" height="0.18"
          color="#34495e"></a-plane>
  <a-text id="uiHasLuggageTxt" value="üß≥ Luggage: NO"
          position="0.952 0.03 0.019" align="center"
          width="1.7" wrap-count="22"
          color="#fff"></a-text>

  <!-- WEIGHTS -->
  <a-text id="uiHandWLabel" value="Backpack weight: 6.0kg"
          position="-1.263 -0.23 0.011" align="left"
          width="2.65" wrap-count="29"
          color="#d0d0d0"></a-text>

  <a-plane id="uiHandMinus" class="clickable"
          position="0.889 -0.23 0.008" width="0.20" height="0.20"
          color="#95a5a6"></a-plane>
  <a-text value="-" position="0.887 -0.23 0.018" align="center" width="2" color="#111" wrap-count="20"></a-text>

  <a-plane id="uiHandPlus" class="clickable"
          position="1.173 -0.23 0.007" width="0.20" height="0.20"
          color="#95a5a6"></a-plane>
  <a-text value="+" position="1.164 -0.23 0.017" align="center" width="1.2" color="#111" wrap-count="20"></a-text>

  <a-text id="uiLuggWLabel" value="Luggage weight: 0.0kg"
          position="-1.262 -0.46 0.011" align="left"
          width="2.4" wrap-count="26"
          color="#d0d0d0"></a-text>

  <a-plane id="uiLuggMinus" class="clickable"
          position="0.889 -0.46 0.008" width="0.20" height="0.20"
          color="#95a5a6"></a-plane>
  <a-text value="-" position="0.887 -0.46 0.018" align="center" width="2" color="#111" wrap-count="20"></a-text>

  <a-plane id="uiLuggPlus" class="clickable"
          position="1.173 -0.46 0.007" width="0.20" height="0.20"
          color="#95a5a6"></a-plane>
  <a-text value="+" position="1.164 -0.46 0.017" align="center" width="1.2" color="#111" wrap-count="20"></a-text>

  <!-- CHECK (online only) -->
  <a-plane id="uiOnlineChecked" class="clickable"
          position="0 -0.717 0.01" width="2.25" height="0.20"
          color="#2c3e50"></a-plane>
  <a-text id="uiOnlineCheckedTxt" value="(Online) Check luggage: NO"
          position="0 -0.682 0.02" align="center"
          width="2.25" wrap-count="28"
          color="#fff"></a-text>

  <!-- WARN -->
  <a-text id="uiFlowWarn" value=""
          position="0 -0.92 0.01" align="center"
          width="2.35" wrap-count="32"
          color="#ffcc66"></a-text>

  <!-- START -->
  <a-plane id="uiFlowStart" class="clickable"
          position="0 -1.15 0.01" width="1.70" height="0.24"
          color="#3498db"></a-plane>
  <a-text value="‚ñ∂Ô∏è START"
          position="0 -1.15 0.02" align="center"
          width="1.9" wrap-count="18"
          color="#fff"></a-text>

</a-entity>

<a-plane
  id="checkinHintBg"
  position="3.287 1 20.283"
  rotation="0 270 0"
  width="3.6"
  height="0.45"
  color="#000"
  material="opacity:0.6; transparent:true"
  visible="false">
</a-plane>

<a-text
  id="checkinHint"
  value="üëÜ Click here to check-in"
  position="3.287 1 20.289"
  rotation="0 270 0"
  align="center"
  width="3.5"
  color="#fff"
  visible="false">
</a-text>



<!-- Painel 3D: Bag Drop (aparece ao clicar no c√≠rculo roxo) -->
<a-entity id="uiBagDropPanel"
          position="4.208 2.083 17.704"
          rotation="0 270 0"
          visible="false"
          face-camera>

  <a-plane width="2.35" height="1.55"
           color="#111"
           radius="0.06"
           material="opacity:0.90; transparent:true; shader: flat"></a-plane>

  <a-text value="üß≥ BAG DROP"
          position="0 0.58 0.01"
          align="center"
          width="2.2"
          wrap-count="18"
          color="#fff"></a-text>

  <a-text id="uiBagDropStatus"
          value="Remaining to drop: ‚Äî"
          position="0 0.22 0.01"
          align="center"
          width="2.2"
          wrap-count="30"
          color="#d0d0d0"></a-text>

  <!-- Bot√µes -->
  <a-plane id="uiDropLuggage" class="clickable"
          position="0 -0.10 0.01"
          width="2.05" height="0.24"
          color="#8e44ad"></a-plane>
  <a-text id="uiDropLuggageTxt"
          value="Drop luggage"
          position="0 -0.10 0.02"
          align="center"
          width="2.1"
          wrap-count="22"
          color="#fff"></a-text>

  <a-plane id="uiDropBackpack" class="clickable"
          position="0 -0.38 0.01"
          width="2.05" height="0.24"
          color="#8e44ad"></a-plane>
  <a-text id="uiDropBackpackTxt"
          value="Drop backpack"
          position="0 -0.38 0.02"
          align="center"
          width="2.1"
          wrap-count="22"
          color="#fff"></a-text>

  <a-plane id="uiBagDropClose" class="clickable"
          position="0 -0.62 0.01"
          width="1.10" height="0.18"
          color="#95a5a6"></a-plane>
  <a-text value="Close"
          position="0 -0.62 0.02"
          align="center"
          width="1.4"
          color="#111"></a-text>

</a-entity>


<!-- Painel 3D: Balc√£o (s√≥ modo airport) -->
<a-entity id="uiDeskPanel"
          position="4.339 2.341 20.233"
          rotation="0 -90 0"
          visible="false"
          face-camera>

  <!-- fundo -->
  <a-plane width="2.55" height="1.75"
           color="#111"
           radius="0.06"
           material="opacity:0.90; transparent:true; shader: flat"></a-plane>

  <a-text value="üè¢ CHECK-IN DESK"
          position="0 0.70 0.01"
          align="center"
          width="2.4"
          wrap-count="26"
          color="#fff"></a-text>

  <!-- c√≥digo -->
  <a-text id="uiDeskCode"
          value="Code: (empty)"
          position="0 0.42 0.01"
          align="center"
          width="2.35"
          wrap-count="28"
          color="#d0d0d0"></a-text>

  <a-plane id="uiDeskEnter" class="clickable"
          position="0 0.18 0.01"
          width="2.15" height="0.22"
          color="#3498db"></a-plane>
  <a-text value="Enter data"
          position="0 0.18 0.02"
          align="center"
          width="2.2"
          color="#fff"></a-text>

  <!-- escolha bagagem -->
  <a-text value="Baggage"
          position="-1.078 -0.06 0.01"
          align="left"
          width="2.2"
          color="#bdbdbd"></a-text>

  <a-plane id="uiDeskHand" class="clickable"
          position="-0.569 -0.304 0.01"
          width="1" height="0.20"
          color="#2c3e50"></a-plane>
  <a-text id="uiDeskHandTxt"
          value="Hand"
          position="-0.553 -0.304 0.02"
          align="center"
          width="1.6"
          color="#fff"></a-text>

  <a-plane id="uiDeskChecked" class="clickable"
          position="0.569 -0.304 0.01"
          width="1" height="0.20"
          color="#2c3e50"></a-plane>
  <a-text id="uiDeskCheckedTxt"
          value="üß≥ Cargo hold"
          position="0.569 -0.304 0.02"
          align="center"
          width="1.6"
          color="#fff"></a-text>

  <!-- warn -->
  <a-text id="uiDeskWarn"
          value=""
          position="0 -0.498 0.01"
          align="center"
          width="2.35"
          wrap-count="34"
          color="#ffcc66"></a-text>

  <!-- confirmar / fechar -->
  <a-plane id="uiDeskConfirm" class="clickable"
          position="-0.552 -0.70 0.01"
          width="1" height="0.20"
          color="#2ecc71"></a-plane>
  <a-text value="Confirm"
          position="-0.552 -0.70 0.02"
          align="center"
          width="1.5"
          color="#111"></a-text>

  <a-plane id="uiDeskClose" class="clickable"
          position="0.571 -0.70 0.01"
          width="1" height="0.20"
          color="#95a5a6"></a-plane>
  <a-text value="Close"
          position="0.578 -0.70 0.02"
          align="center"
          width="1.2"
          color="#111"></a-text>

</a-entity>



<!-- Painel 3D: Seguran√ßa (aparece ao clicar no scanner) -->
<a-entity id="uiSecurityPanel"
          position="2.738 1.826 2.896"
          rotation="0 0 0"
          visible="false"
          face-camera>

  <!-- fundo (maior + cantos arredondados) -->
  <a-plane width="2.35" height="1.55" color="#111"
           radius="0.06"
           material="opacity:0.90; transparent:true; shader: flat"></a-plane>

  <a-text value="üîê SECURITY"
          position="0 0.58 0.01"
          align="center" width="2.2" wrap-count="18"
          color="#fff"></a-text>

  <!-- status -->
  <a-text id="uiSecStatus"
          value="."
          position="0 0.296 0.01"
          align="center" width="2.2" wrap-count="45"
          color="#d0d0d0"></a-text>

  <!-- bot√µes (grid 2 em cima + 1 em baixo) -->
  <a-plane class="clickable" id="uiBtnAddBackpack"
          position="-0.58 -0.05 0.01" width="1.05" height="0.22"
          color="#2c3e50"></a-plane>
  <a-text value="üéí Backpack"
          position="-0.58 -0.05 0.02" align="center"
          width="1.6" wrap-count="16"
          color="#fff"></a-text>

  <a-plane class="clickable" id="uiBtnAddPhone"
          position="0.58 -0.05 0.01" width="1.05" height="0.22"
          color="#2c3e50"></a-plane>
  <a-text value="üì± Phone"
          position="0.58 -0.05 0.02" align="center"
          width="1.6" wrap-count="16"
          color="#fff"></a-text>

  <a-plane class="clickable" id="uiBtnAddLuggage"
          position="0 -0.35 0.01" width="2.16" height="0.22"
          color="#2c3e50"></a-plane>
  <a-text value="üß≥ Luggage (cabin)"
          position="0 -0.35 0.02" align="center"
          width="2.2" wrap-count="22"
          color="#fff"></a-text>

  <a-plane class="clickable" id="uiBtnCloseSec"
          position="0 -0.62 0.01" width="1.20" height="0.18"
          color="#95a5a6"></a-plane>
  <a-text value="Close"
          position="0 -0.62 0.02" align="center"
          width="1.8"
          color="#111"></a-text>

</a-entity>



      <!-- Painel 3D: BP (aparece ao clicar no leitor de BP) -->
      <a-entity id="uiBPPanel"
                position="5.559 1.606 2.807"
                rotation="0 -40 0"
                visible="false"
                face-camera>

        <a-plane width="2.10" height="1.05"
                color="#111"
                radius="0.06"
                material="opacity:0.90; transparent:true; shader: flat"></a-plane>

        <a-text value="üé´ Boarding Pass"
                position="0 0.38 0.01"
                align="center"
                width="2.0"
                wrap-count="22"
                color="#fff"></a-text>

        <a-text id="uiBPStatus"
                value="BP: MISSING"
                position="0 0.173 0.01"
                align="center"
                width="2.0"
                wrap-count="26"
                color="#d0d0d0"></a-text>

        <a-plane id="uiBtnShowBP" class="clickable"
                position="0 -0.106 0.01"
                width="1.65" height="0.2"
                color="#f39c12"></a-plane>
        <a-text value="Show BP"
                position="0 -0.104 0.02"
                align="center"
                width="1.8"
                color="#111"></a-text>

        <a-plane id="uiBtnCloseBP" class="clickable"
                position="0 -0.365 0.01"
                width="1.10" height="0.18"
                color="#95a5a6"></a-plane>
        <a-text value="Close"
                position="0 -0.362 0.02"
                align="center"
                width="1.4"
                color="#111"></a-text>

      </a-entity>


      <!-- Exterior -->
      <a-plane position="0 -0.1 -50" rotation="-90 0 0" width="100" height="300" color="#333" shadow="receive: true"></a-plane>
      <a-plane position="-20 0 -50" rotation="-90 0 0" width="2" height="200" color="#fff"></a-plane>
      <a-plane position="-35 0 -50" rotation="-90 0 0" width="1" height="200" color="#fff"></a-plane>
      <a-box position="0 -0.05 34" width="20" height="0.1" depth="8" color="#7f8c8d"></a-box>

      <!-- =========================
           TERMINAL (MAIOR)
           ========================= -->

      <!-- Ch√£o maior (antes: height=40). Agora estende at√© aos gates -->
      <a-plane position="0 0 -10" rotation="-90 0 0"
               width="18" height="80"
               src="#chao-tex" repeat="5 18" roughness="0.4"
               shadow="receive: true"></a-plane>

      <!-- Teto maior -->
      <a-box position="0 7 -10" width="20" depth="84" height="0.5" color="#fff" shadow="cast: true"></a-box>

      <!-- Paredes laterais (mais compridas) -->
      <a-box position="-9 3.5 -10" width="0.5" height="7" depth="80"
             color="#aaddff" material="opacity: 0.5; transparent: true"></a-box>
      <a-box position="9 3.5 -10" width="0.5" height="7" depth="80"
             src="#parede-tex" repeat="16 2" shadow="cast: true; receive: true"></a-box>

      <!-- Parede do fundo (mais para tr√°s) -->
      <a-box position="0 3.5 -50" width="18" height="7" depth="0.2"
             color="#aaddff" material="opacity: 0.3; transparent: true"></a-box>

      <!-- Portas entrada -->
      <!-- FACHADA / ENTRADA EM VIDRO (com "porta" ao meio) -->
      <!-- Painel esquerdo -->
      <a-box position="-5.5 3.5 29.906" width="7" height="7" depth="0.2"
            color="#aaddff" material="opacity: 0.5; transparent: true"></a-box>

      <!-- Painel direito -->
      <a-box position="5.5 3.5 29.906" width="7" height="7" depth="0.2"
            color="#aaddff" material="opacity: 0.5; transparent: true"></a-box>

      <!-- Pilar esquerdo da porta -->
      <a-box position="-1.2 3.5 29.906" width="0.25" height="7" depth="0.4" color="#333"></a-box>

      <!-- Pilar direito da porta -->
      <a-box position="1.2 3.5 29.906" width="0.25" height="7" depth="0.4" color="#333"></a-box>

      <!-- Travessa superior da porta (opcional, d√° mais "cara" de entrada) -->
      <a-box position="0 6.95 29.906" width="2.4" height="0.15" depth="0.4" color="#333"></a-box>

      <a-box position="0 5 29.941" width="6" height="0.2" depth="4" color="#333"></a-box>
      <a-text value="ENTRADA" position="-0.222 4.515 31.266" rotation="0 0 0" align="center" color="#fff" width="10"></a-text>

      <!-- Luzes ao longo do terminal -->
      <a-entity light="type: point; intensity: 0.55; distance: 18" position="0 6 12"></a-entity>
      <a-entity light="type: point; intensity: 0.55; distance: 18" position="0 6 0"></a-entity>
      <a-entity light="type: point; intensity: 0.55; distance: 18" position="0 6 -12"></a-entity>
      <a-entity light="type: point; intensity: 0.55; distance: 18" position="0 6 -24"></a-entity>
      <a-entity light="type: point; intensity: 0.55; distance: 18" position="0 6 -36"></a-entity>

      <!-- =========================
           CHECK-IN
           ========================= -->
      <a-entity position="3.7 3.579 20.208" rotation="0 270 0" scale="1 1 1">
        <a-box width="4" height="0.6" depth="0.1" color="#1b4f72"></a-box>
        <a-text value="CHECK-IN" align="center" position="0 0 0.06" width="6" color="#fff"></a-text>
      </a-entity>

      <a-entity id="checkinDesk" class="clickable"
      gltf-model="#modelo-balcao" position="5.597 0 17.196"
      scale="0.9 0.9 0.9" rotation="0 180 0" shadow="cast: true"></a-entity>

      <a-box id="checkinDeskHit"
       class="clickable"
       position="5.574 0.052 20.453"
       rotation="0 90 0"
       width="9.2" height="2.2" depth="3.0"
       material="opacity: 0; transparent: true"
       shadow="cast: false; receive: false"></a-box>

       <!-- Dropzone para despachar a mala (por√£o) -->
      <a-cylinder id="baggageDropzone"
        class ="clickable"
        position="3.516 0.392 17.701"
        rotation="90 90 0"
        scale="0.5 0.5 0.5"
        radius="0.7" height="0.06"
        color="#8e44ad"
        material="opacity:0.85; transparent:true"></a-cylinder>

      <a-text value="BAG DROP" position="3.537 0.981 17.721"  rotation="0 270 0"
        align="center" width="4" color="#e9d7ff"></a-text>



      <a-entity gltf-model="#modelo-balcao" position="5.597 0 23.292"  scale="0.9 0.9 0.9" rotation="0 180 0" shadow="cast: true"></a-entity>

      <!-- MALA (aparece no check-in; click = pegar/largar) -->
      <a-entity id="luggage" class="clickable"
                position="3 0 20.866" rotation="0 90 0" visible="true">
        <a-entity class="clickable"
                  gltf-model="#modelo-mala"
                  scale="1.5 1.5 1.5"
                  rotation="0 0 0">
        </a-entity>
      </a-entity>

      <!-- MOCHILA (item pessoal para quando escolhe POR√ÉO) -->
      <a-entity id="backpack" class="clickable"
                position="3.35 0 20.866" rotation="0 90 0" visible="false">
        <a-entity class="clickable"
                  gltf-model="#modelo-backpack"
                  scale="1.5 1.5 1.5"
                  rotation="0 0 0">
        </a-entity>
      </a-entity>

      <!-- TELEM√ìVEL (come√ßa invis√≠vel e no invent√°rio, mas existe no mundo para feedback no scanner) -->
      <a-entity id="phone" class="clickable"
                position="3.7 0.258 20.866" rotation="50 90 0" visible="false">
        <a-entity class="clickable"
                  gltf-model="#modelo-iphone"
                  position="0 0.300 0"
                  scale="2 2 2"
                  rotation="0 0 0">
        </a-entity>
      </a-entity>


      <!-- =========================
     CADEIRAS NA ZONA DO CHECK-IN
     (4 cadeiras, depois ajustas rota√ß√£o/posi√ß√£o)
     ========================= -->
      <a-entity id="checkinChairs" position="2.5 0 22" rotation="0 90 0">
        <a-entity gltf-model="#modelo-cadeira" position="1.832 0 -9.5"   rotation="0 0 0" scale="1 1 1"></a-entity>
        <a-entity gltf-model="#modelo-cadeira" position="1.832 0 -7.5" rotation="0 0 0" scale="1 1 1"></a-entity>
        <a-entity gltf-model="#modelo-cadeira" position="4.832 0 -9.5"  rotation="0 0 0" scale="1 1 1"></a-entity>
        <a-entity gltf-model="#modelo-cadeira" position="4.832 0 -7.5" rotation="0 0 0" scale="1 1 1"></a-entity>
        <a-entity gltf-model="#modelo-cadeira" position="-1.168 0 -9.5" rotation="0 0 0" scale="1 1 1"></a-entity>
        <a-entity gltf-model="#modelo-cadeira" position="-1.168 0 -7.5" rotation="0 0 0" scale="1 1 1"></a-entity>
      </a-entity>

      <!-- =========================
           SECURITY (mantida)
           ========================= -->
        <a-entity position="0 0 1"> <a-box id="securityWall" 
               position="0 2.5 0" 
               width="5.5" height="5" depth="0.1" 
               color="red" 
               material="opacity: 0.3; transparent: true; side: double"
               visible="true">
        </a-box>
        
        <a-text id="securityWallText" value="PARE!\nApresente o cart√£o de embarque\ne passe no scanner."
                align="center" position="0 3.621 0.1" width="6" color="red"></a-text>

        <a-box position="0 4.618 1.078" width="4" height="0.6" depth="0.1" color="#196f3d"></a-box>
        <a-text value="SECURITY CHECK" align="center" position="0 4.638 1.179" width="6" color="#fff"></a-text>

        <a-entity gltf-model="#modelo-security" position="-2.712 0 0" scale="0.9 0.9 0.9" rotation="0 90 0"></a-entity>
        <a-entity gltf-model="#modelo-security" position="2.712 0 0" scale="0.9 0.9 0.9" rotation="0 270 0"></a-entity>

        <a-entity
          id="scannerSfxEntity"
          position="2.771 1.2 1.625"
          sound="src: #scannerSfx; volume: 0.9; poolSize: 5; positional: true; refDistance: 2; distanceModel: inverse"
        ></a-entity>




        <!-- DROPZONE DO SCANNER (onde tens de largar a mala) -->
        <a-cylinder id="securityDropzone"
                    class ="clickable"
                    position="2.771 0.937 1.625"
                    radius="0.8" height="0.05"
                    color="#27ae60"
                    material="opacity: 0.80; transparent: true"
                    shadow="receive: true">
        </a-cylinder>

        <a-text value="SCANNER" position="2.780 1.270 1.744"
                align="center" width="4" color="#b7f5d1"></a-text>
      </a-entity>

      <a-box id="securityBarrier"
       position="0 1.6 -0.3"
       width="8" height="4" depth="1.2"
       visible="false"
       material="opacity: 0; transparent: true"></a-box>


      <!-- Leitor do cart√£o de embarque (mostrar BP) -->
      <a-box id="bpReader"
        position="4.066 1.3 1.843"
        width="0.5" height="0.6" depth="0.2"
        color="#2ecc71"
        class="clickable"></a-box>
      <a-text value="SCAN BP" position="4.086 1.765 1.2"
        align="center" width="4" color="#c8ffe0"></a-text>


      <!-- =========================
           CORREDOR PARA GATES + SINAL
           ========================= -->
      <a-entity id="gateSign" position="0 3.5 -21.241">
        <a-box width="6" height="0.8" depth="0.12" color="#111"></a-box>
        <a-text id="gateSignText" value="GATES AREA" align="center" position="0 0 0.08" width="8" color="#fff"></a-text>
      </a-entity>

      <!-- =========================
           WAITING AREA (CADEIRAS)
           ========================= -->

      <!-- Tapete/√°rea de espera -->
      <a-plane position="0 0.01 -28" rotation="-90 0 0" width="16" height="14"
               color="#2c3e50" material="opacity: 0.35; transparent: true"></a-plane>

      <!-- Cadeiras em grelha (3 colunas x 4 filas) -->
      <a-entity id="waitingArea" position="0 0 -26">
        <!-- fila 1 -->
        <a-entity gltf-model="#modelo-cadeira" position="-4 0 0"  rotation="0 180 0" scale="1 1 1"></a-entity>
        <a-entity gltf-model="#modelo-cadeira" position="0 0 0"   rotation="0 180 0" scale="1 1 1"></a-entity>
        <a-entity gltf-model="#modelo-cadeira" position="4 0 0"   rotation="0 180 0" scale="1 1 1"></a-entity>

        <!-- fila 2 -->
        <a-entity gltf-model="#modelo-cadeira" position="-4 0 -3" rotation="0 180 0" scale="1 1 1"></a-entity>
        <a-entity gltf-model="#modelo-cadeira" position="0 0 -3"  rotation="0 180 0" scale="1 1 1"></a-entity>
        <a-entity gltf-model="#modelo-cadeira" position="4 0 -3"  rotation="0 180 0" scale="1 1 1"></a-entity>

        <!-- fila 3 -->
        <a-entity gltf-model="#modelo-cadeira" position="-4 0 -6" rotation="0 180 0" scale="1 1 1"></a-entity>
        <a-entity gltf-model="#modelo-cadeira" position="0 0 -6"  rotation="0 180 0" scale="1 1 1"></a-entity>
        <a-entity gltf-model="#modelo-cadeira" position="4 0 -6"  rotation="0 180 0" scale="1 1 1"></a-entity>

        <!-- fila 4 -->
        <a-entity gltf-model="#modelo-cadeira" position="-4 0 -9" rotation="0 180 0" scale="1 1 1"></a-entity>
        <a-entity gltf-model="#modelo-cadeira" position="0 0 -9"  rotation="0 180 0" scale="1 1 1"></a-entity>
        <a-entity gltf-model="#modelo-cadeira" position="4 0 -9"  rotation="0 180 0" scale="1 1 1"></a-entity>
      </a-entity>

      <!-- =========================
           GATES (mais para tr√°s + placas 3D)
           ========================= -->


<a-text id="previewTitle"
        value="PREVIEW: ‚Äî"
        align="center"
        position="0 2.348 -39.125"
        color="#333"
        scale="1.5 1.5 1.5" face-camera></a-text>

<a-text id="previewHint"
        value="(Click to see destination)"
        align="center"
        position="0 1.909 -39.160"
        color="#555"
        scale="0.8 0.8 0.8" face-camera></a-text>

<a-sphere class="clickable"
          destination-preview
          position="0 0.962 -39.120"
          radius="0.6"
          color="#3498db"
          material="opacity: 0.9; roughness: 0.2; metalness: 0.8">
</a-sphere>


      <!-- Gate A1 -->
      <a-entity id="gateA1" position="-6 1 -44">
        <a-box id="gateA1Box"width="2.4" height="2.2" depth="0.12" color="#d8b88f"></a-box>
        <a-text value="GATE A1" position="0 1.35 0.14" align="center" color="#111"></a-text>

        <!-- placa 3D do gate -->
        <a-entity gltf-model="#modelo-gate-sign" position="0 2.8 0.6" rotation="0 0 0" scale="0.25 0.25 0.25"></a-entity>
        <a-text value="A1" position="0 3.35 0.7" align="center" color="#fff" width="6"></a-text>
      </a-entity>

      <!-- Gate A2 -->
      <a-entity id="gateA2" position="0 1 -44">
        <a-box id="gateA2Box" width="2.4" height="2.2" depth="0.12" color="#d8b88f"></a-box>
        <a-text value="GATE A2" position="0 1.35 0.14" align="center" color="#111"></a-text>

        <a-entity gltf-model="#modelo-gate-sign" position="0 2.8 0.6" rotation="0 0 0" scale="0.25 0.25 0.25"></a-entity>
        <a-text value="A2" position="0 3.35 0.7" align="center" color="#fff" width="6"></a-text>
      </a-entity>

      <!-- Gate A3 -->
      <a-entity id="gateA3" position="6 1 -44">
        <a-box id="gateA3Box" width="2.4" height="2.2" depth="0.12" color="#d8b88f"></a-box>
        <a-text value="GATE A3" position="0 1.35 0.14" align="center" color="#111"></a-text>

        <a-entity gltf-model="#modelo-gate-sign" position="0 2.8 0.6" rotation="0 0 0" scale="0.25 0.25 0.25"></a-entity>
        <a-text value="A3" position="0 3.35 0.7" align="center" color="#fff" width="6"></a-text>
      </a-entity>

    </a-scene>
  </body>
</html>
